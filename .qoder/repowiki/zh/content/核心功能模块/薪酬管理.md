# 薪酬管理

<cite>
**本文档引用文件**  
- [PayrollPeriod.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollPeriod.cs)
- [PayrollRecord.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollRecord.cs)
- [PayrollConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/PayrollConfiguration.cs)
- [PayrollController.cs](file://Backend/Hrevolve.Web/Controllers/PayrollController.cs)
- [PeriodsView.vue](file://Frontend/hrevolve-web/src/views/payroll/PeriodsView.vue)
- [RecordsView.vue](file://Frontend/hrevolve-web/src/views/payroll/RecordsView.vue)
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs)
- [payroll.ts](file://Frontend/hrevolve-web/src/api/modules/payroll.ts)
</cite>

## 目录
1. [引言](#引言)
2. [领域模型设计](#领域模型设计)
3. [薪资计算流程](#薪资计算流程)
4. [应用层命令执行机制](#应用层命令执行机制)
5. [EF Core 配置实现](#ef-core-配置实现)
6. [前端功能展示](#前端功能展示)
7. [性能与审计能力](#性能与审计能力)

## 引言
本技术文档详细阐述了Hrevolve系统中薪酬管理模块的设计与实现。该模块以领域驱动设计（DDD）为核心，构建了完整的薪资周期管理和薪资单计算体系。系统通过PayrollPeriod和PayrollRecord两个核心实体管理薪资周期和员工薪资记录，支持灵活的薪资项配置、自动化计算规则以及多级审批流程。模块采用CQRS架构模式，结合Mediator模式实现命令与查询的分离，确保业务逻辑的清晰与可维护性。同时，系统具备多租户隔离、软删除、审计日志等企业级特性，满足复杂组织架构下的薪酬管理需求。

## 领域模型设计

薪酬管理模块的核心领域模型由`PayrollPeriod`（薪资周期）和`PayrollRecord`（薪资记录）两个聚合根构成，它们共同定义了薪资计算的上下文边界。

### PayrollPeriod 实体
`PayrollPeriod`实体代表一个具体的薪资计算周期，是薪资计算的顶层容器。其关键属性包括：
- **Name**: 周期名称（如“2025年12月”）
- **Year/Month**: 年份和月份，用于标识周期
- **StartDate/EndDate**: 周期的起止日期，定义了考勤和薪资计算的时间范围
- **PayDate**: 发薪日期
- **Status**: 周期状态，采用枚举`PayrollPeriodStatus`，包含`Open`（开放）、`Processing`（计算中）、`Locked`（已锁定）和`Closed`（已关闭）四种状态，实现了严格的生命周期管理
- **LockedAt/LockedBy**: 锁定时间和操作人，用于审计追踪

该实体通过工厂方法`Create`进行实例化，并提供`Lock`和`Close`等业务方法来改变其状态，确保了业务规则的内聚性。

### PayrollRecord 实体
`PayrollRecord`实体代表单个员工在特定薪资周期内的薪资记录。它与`PayrollPeriod`形成聚合关系，是薪资计算的核心单元。其关键属性包括：
- **BaseSalary**: 基本工资
- **GrossSalary**: 应发工资总额
- **TotalDeductions**: 扣除总额
- **NetSalary**: 实发工资
- **IncomeTax**: 个人所得税
- **SocialInsurance/HousingFund**: 社保和公积金的个人与公司部分金额
- **Status**: 记录状态，采用枚举`PayrollRecordStatus`，包含`Draft`（草稿）、`Calculated`（已计算）、`Approved`（已审批）和`Paid`（已发放）四种状态
- **CalculationLog/DataSnapshot**: 计算日志和数据快照，以JSON格式存储，为审计和追溯提供关键数据

`PayrollRecord`通过`Details`集合（`IReadOnlyCollection<PayrollDetail>`）管理薪资明细，实现了薪资项的灵活构成。

### PayrollItem 实体
`PayrollItem`实体定义了薪资项的模板，是薪资计算规则的载体。其关键属性包括：
- **Name/Code**: 薪资项名称和代码
- **Type**: 薪资项类型，采用枚举`PayrollItemType`，分为`Earning`（收入项）、`Deduction`（扣除项）、`Benefit`（福利项）和`Tax`（税项）
- **CalculationType**: 计算类型，采用枚举`CalculationType`，支持`Fixed`（固定金额）、`Formula`（公式计算）、`Manual`（手动输入）和`External`（外部数据）四种模式
- **FixedAmount/Formula**: 固定金额或计算公式
- **IsTaxable**: 是否计税标志

该设计支持了复杂的薪资构成和税务扣减规则，为规则引擎提供了基础数据。

**Section sources**
- [PayrollPeriod.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollPeriod.cs#L8-L80)
- [PayrollRecord.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollRecord.cs#L8-L132)
- [PayrollPeriod.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollPeriod.cs#L85-L157)

## 薪资计算流程

薪资计算流程是一个由规则引擎驱动的批量处理过程，旨在高效、准确地完成全公司员工的薪资计算。

### 规则引擎驱动机制
虽然具体的规则引擎实现尚未在代码中完全体现，但从`PayrollItem`的设计可以看出其架构意图。`CalculationType`为`Formula`的薪资项，其`Formula`字段将存储可执行的计算表达式。规则引擎在计算时会：
1.  加载指定薪资周期内的所有有效`PayrollItem`
2.  根据`CalculationType`对每个薪资项进行处理
3.  对于`Formula`类型，解析并执行公式，可能涉及调用外部服务（如考勤系统获取出勤天数）或访问数据库中的员工数据（如职位、职级）
4.  将计算结果作为`PayrollDetail`添加到对应的`PayrollRecord`中

例如，一个名为“绩效奖金”的薪资项，其公式可能为`BaseSalary * PerformanceCoefficient`，其中`PerformanceCoefficient`来自员工的绩效考核结果。

### 批量计算流程
批量计算流程通过`PayrollController`中的`CalculatePayroll`端点触发，其执行顺序如下：
1.  **请求接收**: 前端调用`/api/payroll/periods/{periodId}/calculate`，可选择是否为试算（`isDryRun=true`）
2.  **权限验证**: `RequirePermission`属性确保调用者具有`PayrollWrite`权限
3.  **命令分发**: Mediator模式将请求分发给相应的命令处理器
4.  **状态检查**: 系统检查`PayrollPeriod`的状态是否为`Open`，确保计算在正确的生命周期阶段进行
5.  **数据准备**: 加载该周期内所有相关员工的`PayrollRecord`（或创建新的草稿记录）
6.  **规则执行**: 对每个`PayrollRecord`，遍历所有`PayrollItem`，根据其`CalculationType`计算金额并生成`PayrollDetail`
7.  **总额计算**: 调用`PayrollRecord.Calculate()`方法，汇总所有明细，计算`GrossSalary`、`TotalDeductions`、`NetSalary`等总额
8.  **结果存储**: 将计算结果（包括明细、总额、计算日志和数据快照）持久化到数据库
9.  **状态更新**: 更新`PayrollPeriod`状态为`Processing`或`Locked`，并更新`PayrollRecord`状态为`Calculated`
10. **响应返回**: 向前端返回计算结果

此流程支持试算功能，允许HR在正式计算前预览结果，降低了操作风险。

**Section sources**
- [PayrollController.cs](file://Backend/Hrevolve.Web/Controllers/PayrollController.cs#L41-L50)
- [PayrollRecord.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollRecord.cs#L105-L113)
- [PayrollPeriod.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollPeriod.cs#L61-L71)

## 应用层命令执行机制

应用层采用CQRS和Mediator模式来处理薪酬管理相关的命令，确保了业务逻辑的清晰分离和可扩展性。

### 命令执行顺序
以创建薪资周期为例，命令的执行顺序体现了典型的CQRS流程：
1.  **前端发起**: `PeriodsView.vue`中的操作触发对`payrollApi`的调用
2.  **API接收**: `PayrollController.CreatePayrollPeriod`接收到HTTP POST请求
3.  **命令创建**: 将请求数据映射到`CreatePayrollPeriodRequest` DTO
4.  **Mediator分发**: 通过`IMediator`将命令发送给对应的`IRequestHandler`
5.  **验证执行**: `ValidationBehavior`管道行为自动执行FluentValidation验证，确保输入数据的合法性
6.  **日志记录**: `LoggingBehavior`管道行为记录请求的开始和结束，便于监控和调试
7.  **业务处理**: 命令处理器（如`CreatePayrollPeriodCommandHandler`）被调用，执行核心业务逻辑（如创建`PayrollPeriod`实体、检查唯一性约束）
8.  **持久化**: 通过`IUnitOfWork`和`IRepository`将变更保存到数据库
9.  **结果返回**: 返回`Result<Guid>`，包含操作成功或失败的信息

### 错误处理机制
系统采用了分层的错误处理策略：
- **输入验证**: `ValidationBehavior`统一处理所有命令的输入验证，抛出`ValidationException`，前端可解析并展示具体的错误字段。
- **业务规则**: 在命令处理器中，通过`Result.Failure<T>`返回业务层面的错误（如“薪资周期已存在”），保持了业务逻辑的纯净。
- **异常捕获**: `ExceptionHandlingMiddleware`全局捕获未处理的异常，将其转换为标准的HTTP错误响应（如500 Internal Server Error），避免敏感信息泄露。
- **日志记录**: `LoggingBehavior`在异常发生时记录详细的错误信息和堆栈跟踪，为问题排查提供依据。

这种机制确保了错误信息的清晰传递和系统的健壮性。

**Section sources**
- [PayrollController.cs](file://Backend/Hrevolve.Web/Controllers/PayrollController.cs#L30-L36)
- [LoggingBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/LoggingBehavior.cs#L12-L48)
- [ValidationBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/ValidationBehavior.cs#L12-L37)

## EF Core 配置实现

EF Core的配置在`PayrollConfiguration.cs`文件中定义，确保了领域模型到数据库的正确映射和性能优化。

### 金额精度控制
所有涉及金额的字段均通过`HasPrecision(18, 2)`方法配置，确保了财务数据的精确性。这包括：
- `PayrollItem.FixedAmount`
- `PayrollRecord`中的所有金额字段（`BaseSalary`, `GrossSalary`, `NetSalary`等）
- `PayrollDetail.Amount`

此配置将数据库字段定义为`decimal(18,2)`，支持最大16位整数和2位小数，满足了企业级财务应用的需求。

### 历史记录存储
系统通过以下方式实现历史记录的存储和审计：
- **数据快照**: `PayrollRecord.DataSnapshot`字段以JSON格式存储计算时的关键数据（如员工的基本工资、考勤记录等），即使原始数据后续被修改，也能追溯计算时的原始状态。
- **计算日志**: `PayrollRecord.CalculationLog`字段记录详细的计算步骤和中间结果，便于复现和排查计算问题。
- **审计实体**: 所有实体均继承自`AuditableEntity`，自动记录`CreatedAt`、`CreatedBy`、`UpdatedAt`等审计字段。
- **软删除**: `HrevolveDbContext`中通过`ConfigureSoftDeleteFilter`全局查询过滤器实现了软删除，被删除的记录通过`IsDeleted`标记，而非物理删除，保证了数据的完整性。

### 索引策略
配置中定义了多个关键索引以优化查询性能：
- **唯一性索引**: 
  - `PayrollPeriod`上的`(TenantId, Year, Month)`确保了每个租户下每月只能有一个薪资周期。
  - `PayrollItem`上的`(TenantId, Code)`确保了薪资项代码在租户内的唯一性。
  - `PayrollRecord`上的`(TenantId, EmployeeId, PayrollPeriodId)`确保了每个员工在每个周期内只能有一条薪资记录。
- **查询优化**: 这些索引极大地加速了基于租户、年月、员工ID等常用条件的查询操作。

```mermaid
erDiagram
PAYROLL_PERIOD ||--o{ PAYROLL_RECORD : "包含"
PAYROLL_ITEM ||--o{ PAYROLL_DETAIL : "定义"
PAYROLL_RECORD ||--o{ PAYROLL_DETAIL : "包含"
PAYROLL_PERIOD {
string Name
int Year
int Month
DateOnly StartDate
DateOnly EndDate
DateOnly PayDate
string Status
DateTime? LockedAt
Guid? LockedBy
}
PAYROLL_RECORD {
decimal BaseSalary
decimal GrossSalary
decimal TotalDeductions
decimal NetSalary
decimal IncomeTax
decimal SocialInsuranceEmployee
decimal SocialInsuranceEmployer
decimal HousingFundEmployee
decimal HousingFundEmployer
string Status
DateTime? CalculatedAt
string? CalculationLog
string? DataSnapshot
}
PAYROLL_ITEM {
string Name
string Code
string Type
string CalculationType
decimal? FixedAmount
string? Formula
bool IsTaxable
int SortOrder
bool IsActive
}
PAYROLL_DETAIL {
string ItemName
string ItemType
decimal Amount
string? Remarks
}
```

**Diagram sources**
- [PayrollPeriod.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollPeriod.cs#L8-L80)
- [PayrollRecord.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollRecord.cs#L8-L132)
- [PayrollConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/PayrollConfiguration.cs#L5-L147)

**Section sources**
- [PayrollConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/PayrollConfiguration.cs#L72-L121)
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L77-L118)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs#L6-L47)

## 前端功能展示

前端通过Vue 3和Element Plus构建了直观的用户界面，主要包含两个核心视图：`PeriodsView.vue`和`RecordsView.vue`。

### PeriodsView.vue (薪资周期管理)
该视图用于管理员管理薪资周期。
- **数据获取**: 在`onMounted`钩子中调用`payrollApi.getPeriods()`获取周期列表。
- **数据展示**: 使用`el-table`组件展示`PayrollPeriod`的列表，包括名称、年月、起止日期等关键信息。
- **状态可视化**: 通过`getStatusType`函数将`Status`枚举值映射为Element Plus的`el-tag`标签类型（如`Open`为success绿色，`Locked`为danger红色），使状态一目了然。
- **国际化**: 使用`vue-i18n`实现界面文本的多语言支持。

### RecordsView.vue (薪资单查看)
该视图用于员工和管理员查看薪资单。
- **数据获取**: 调用`payrollApi.getRecords()`获取薪资记录。
- **数据展示**: 使用`el-table`展示`PayrollRecord`列表，关键字段包括员工姓名、周期、基本工资和实发工资。
- **金额格式化**: 使用`Intl.NumberFormat`将金额格式化为带货币符号（CNY）的本地化格式。
- **状态标签**: 使用`computed`属性`statusLabels`结合`vue-i18n`对状态进行翻译，并通过`getStatusType`设置标签样式，提升了用户体验。

这两个视图共同构成了薪酬管理的前端入口，操作简单，信息清晰。

**Section sources**
- [PeriodsView.vue](file://Frontend/hrevolve-web/src/views/payroll/PeriodsView.vue#L1-L41)
- [RecordsView.vue](file://Frontend/hrevolve-web/src/views/payroll/RecordsView.vue#L1-L51)
- [payroll.ts](file://Frontend/hrevolve-web/src/api/modules/payroll.ts#L5-L35)

## 性能与审计能力

系统在设计上充分考虑了大数据量下的性能和审计追溯能力。

### 计算性能优化
- **批量处理**: 薪资计算采用批量处理模式，避免了逐个员工发起请求的高延迟。
- **索引优化**: 数据库层面的关键索引（如`(TenantId, EmployeeId, PayrollPeriodId)`）确保了数据查询的高效性。
- **异步处理**: 虽然当前代码显示为同步，但`CalculatePayroll`方法的`async Task<IActionResult>`签名表明其设计为异步操作，可利用`await`进行非阻塞I/O，提高并发处理能力。
- **缓存策略**: 未来可引入Redis等缓存机制，缓存频繁访问的`PayrollItem`配置和员工基本信息，减少数据库查询。

### 审计追溯能力
系统具备强大的审计能力，满足财务合规要求：
- **完整数据快照**: `DataSnapshot`字段保存了计算时的原始数据，是追溯的核心。
- **详细计算日志**: `CalculationLog`记录了每一步的计算过程，可用于复现和验证。
- **操作审计**: `AuditableEntity`基类记录了所有实体的创建、修改和删除操作人及时间。
- **状态变迁**: `PayrollPeriod`和`PayrollRecord`的状态机清晰地记录了业务流程的进展。
- **全局审计日志**: `HrevolveDbContext`中的`AuditLogs` DbSet可用于记录更详细的审计事件。

这些特性共同确保了薪酬计算过程的透明、可追溯和不可篡改。

**Section sources**
- [PayrollRecord.cs](file://Backend/Hrevolve.Domain/Payroll/PayrollRecord.cs#L72-L74)
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L61)
- [PayrollConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/PayrollConfiguration.cs#L107-L108)