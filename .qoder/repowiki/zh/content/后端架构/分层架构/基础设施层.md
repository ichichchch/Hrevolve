# 基础设施层

<cite>
**本文档中引用的文件**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs)
- [EmployeeRepository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/EmployeeRepository.cs)
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs)
- [DbInitializer.cs](file://Backend/Hrevolve.Infrastructure/Persistence/DbInitializer.cs)
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs)
- [IRepository.cs](file://Backend/Hrevolve.Domain/Common/IRepository.cs)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs)
- [ICurrentUser.cs](file://Backend/Hrevolve.Shared/Identity/ICurrentUser.cs)
- [appsettings.json](file://Backend/Hrevolve.Web/appsettings.json)
- [InitialCreate.cs](file://Backend/Hrevolve.Infrastructure/Migrations/20251227093819_InitialCreate.cs)
- [TenantConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/TenantConfiguration.cs)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
基础设施层是Hrevolve系统的核心技术实现适配器，负责将领域层的抽象定义转化为具体的技术实现。该层通过Entity Framework Core（EF Core）实现对象关系映射（ORM），为上层应用提供数据持久化能力。本技术文档系统阐述基础设施层的设计与实现，重点关注多租户数据隔离、仓储模式实现、数据库迁移策略以及缓存集成等关键机制。

## 项目结构
基础设施层的项目结构遵循清晰的分层设计，主要包含持久化、多租户和依赖注入三大模块。持久化模块负责数据库上下文、实体配置和仓储实现；多租户模块处理租户解析和上下文管理；依赖注入模块配置服务注册。

```mermaid
graph TB
subgraph "基础设施层"
Persistence[Persistence]
MultiTenancy[MultiTenancy]
DI[DependencyInjection]
end
Persistence --> HrevolveDbContext[HrevolveDbContext]
Persistence --> Configurations[Configurations]
Persistence --> Repositories[Repositories]
Persistence --> DbInitializer[DbInitializer]
MultiTenancy --> TenantResolver[TenantResolver]
DI --> DependencyInjection[DependencyInjection]
HrevolveDbContext --> Configurations
HrevolveDbContext --> Repositories
TenantResolver --> HrevolveDbContext
DependencyInjection --> HrevolveDbContext
DependencyInjection --> TenantResolver
```

**图表来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs)

**本节来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs)

## 核心组件
基础设施层的核心组件包括HrevolveDbContext、通用仓储实现、实体配置类和多租户解析器。这些组件协同工作，实现了数据持久化、多租户隔离和依赖注入等关键功能。

**本节来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs)
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)

## 架构概述
基础设施层的架构设计体现了清晰的分层和关注点分离原则。EF Core作为ORM框架，通过HrevolveDbContext实现领域实体与数据库表的映射。仓储模式提供了一致的数据访问接口，而多租户机制确保了数据隔离。

```mermaid
graph TD
subgraph "基础设施层"
DbContext[HrevolveDbContext]
Repository[仓储]
Configuration[实体配置]
TenantResolver[租户解析器]
Cache[缓存]
end
subgraph "领域层"
Domain[领域实体]
end
Domain --> DbContext
DbContext --> Configuration
DbContext --> Repository
Repository --> DbContext
TenantResolver --> DbContext
Cache --> TenantResolver
DbContext --> Database[(数据库)]
```

**图表来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs)
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)

## 详细组件分析
本节深入分析基础设施层的关键组件，包括数据库上下文、仓储模式、实体配置和多租户机制。

### 数据库上下文分析
HrevolveDbContext是EF Core的核心组件，负责管理数据库连接、事务和查询。它通过构造函数注入租户上下文和当前用户访问器，实现多租户和审计功能。

```mermaid
classDiagram
class HrevolveDbContext {
+DbSet<Tenant> Tenants
+DbSet<Employee> Employees
+DbSet<User> Users
+DbSet<OrganizationUnit> OrganizationUnits
+DbSet<LeaveRequest> LeaveRequests
+DbSet<PayrollRecord> PayrollRecords
+DbSet<ExpenseRequest> ExpenseRequests
+DbSet<AuditLog> AuditLogs
+SaveChangesAsync() int
-ConfigureTenantFilter()
-ConfigureSoftDeleteFilter()
}
HrevolveDbContext --> ITenantContextAccessor : "依赖"
HrevolveDbContext --> ICurrentUserAccessor : "依赖"
HrevolveDbContext --> ModelBuilder : "配置"
```

**图表来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L9-L156)

**本节来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L9-L156)

### 仓储模式分析
仓储模式通过IRepository接口和Repository基类实现，为上层应用提供统一的数据访问抽象。通用仓储支持基本的CRUD操作，而具体实体仓储可扩展特定查询。

```mermaid
classDiagram
class IRepository~T~ {
+GetByIdAsync(Guid id) T?
+GetAllAsync() IReadOnlyList~T~
+FindAsync(Expression~Func~T,bool~~ predicate) IReadOnlyList~T~
+AddAsync(T entity) T
+UpdateAsync(T entity) void
+DeleteAsync(T entity) void
+ExistsAsync(Guid id) bool
+CountAsync(Expression~Func~T,bool~~? predicate) int
}
class Repository~T~ {
-HrevolveDbContext Context
-DbSet~T~ DbSet
+Repository(HrevolveDbContext context)
}
class IEmployeeRepository {
+GetByEmployeeNumberAsync(string employeeNumber) Employee?
+GetWithJobHistoryAsync(Guid id) Employee?
+GetByDepartmentAsync(Guid departmentId) IReadOnlyList~Employee~
+GetDirectReportsAsync(Guid managerId) IReadOnlyList~Employee~
+GetJobHistoryAtDateAsync(Guid employeeId, DateOnly date) JobHistory?
}
class EmployeeRepository {
+EmployeeRepository(HrevolveDbContext context)
}
IRepository~T~ <|.. Repository~T~
Repository~T~ <|-- EmployeeRepository
IEmployeeRepository <|.. EmployeeRepository
Repository~T~ --> HrevolveDbContext
```

**图表来源**  
- [IRepository.cs](file://Backend/Hrevolve.Domain/Common/IRepository.cs#L8-L30)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs#L6-L65)
- [EmployeeRepository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/EmployeeRepository.cs#L6-L81)

**本节来源**  
- [IRepository.cs](file://Backend/Hrevolve.Domain/Common/IRepository.cs#L8-L30)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs#L6-L65)
- [EmployeeRepository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/EmployeeRepository.cs#L6-L81)

### 实体配置分析
实体配置类使用EF Core的Fluent API定义数据库表结构、索引和关系。EmployeeConfiguration类展示了如何配置员工实体的属性、索引和自引用关系。

```mermaid
classDiagram
class EmployeeConfiguration {
+Configure(EntityTypeBuilder~Employee~ builder)
}
class JobHistoryConfiguration {
+Configure(EntityTypeBuilder~JobHistory~ builder)
}
class TenantConfiguration {
+Configure(EntityTypeBuilder~Tenant~ builder)
}
EmployeeConfiguration --> Employee : "配置"
JobHistoryConfiguration --> JobHistory : "配置"
TenantConfiguration --> Tenant : "配置"
class Employee {
+Guid Id
+string EmployeeNumber
+string FirstName
+string LastName
+Guid? DirectManagerId
+Guid TenantId
}
class JobHistory {
+Guid Id
+Guid EmployeeId
+DateOnly EffectiveStartDate
+DateOnly EffectiveEndDate
+Guid TenantId
}
class Tenant {
+Guid Id
+string Name
+string Code
+string? Domain
+TenantSettings Settings
}
Employee --> JobHistory : "包含"
Employee --> Employee : "直属上级"
Tenant --> Employee : "拥有"
```

**图表来源**  
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs#L5-L70)
- [TenantConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/TenantConfiguration.cs#L7-L55)

**本节来源**  
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs#L5-L70)
- [TenantConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/TenantConfiguration.cs#L7-L55)

### 多租户机制分析
多租户机制通过全局查询过滤器实现数据隔离。HrevolveDbContext为所有AuditableEntity添加租户过滤器，确保查询结果仅包含当前租户的数据。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Middleware as "TenantMiddleware"
participant Resolver as "TenantResolver"
participant Cache as "Redis缓存"
participant DbContext as "HrevolveDbContext"
participant Database as "数据库"
Client->>Middleware : HTTP请求
Middleware->>Middleware : 检查JWT租户ID
alt JWT包含租户ID
Middleware->>Resolver : GetByIdAsync(tenantId)
Resolver->>Cache : 查询缓存
alt 缓存命中
Cache-->>Resolver : 返回租户信息
else 缓存未命中
Resolver->>Database : 查询租户
Database-->>Resolver : 返回租户
Resolver->>Cache : 缓存结果
end
Resolver-->>Middleware : 返回租户信息
else 从请求解析租户
Middleware->>Middleware : 解析租户标识
Middleware->>Resolver : ResolveAsync(identifier)
Resolver->>Cache : 查询缓存
alt 缓存命中
Cache-->>Resolver : 返回租户信息
else 缓存未命中
Resolver->>Database : 查询租户
Database-->>Resolver : 返回租户
Resolver->>Cache : 缓存结果
end
Resolver-->>Middleware : 返回租户信息
end
Middleware->>DbContext : 设置租户上下文
DbContext->>Database : 执行查询自动添加租户过滤器
Database-->>DbContext : 返回过滤后的数据
DbContext-->>Client : 返回响应
```

**图表来源**  
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L132)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs#L13-L107)
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L77-L98)

**本节来源**  
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L132)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs#L13-L107)
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L77-L98)

## 依赖分析
基础设施层依赖于领域层的实体定义和共享层的接口契约。通过依赖注入，各组件之间的耦合度被有效降低。

```mermaid
graph TD
Infrastructure[基础设施层] --> Domain[领域层]
Infrastructure --> Shared[共享层]
Domain --> Common[Common]
Shared --> MultiTenancy[MultiTenancy]
Shared --> Identity[Identity]
Infrastructure --> HrevolveDbContext[HrevolveDbContext]
HrevolveDbContext --> Domain
HrevolveDbContext --> Shared
Infrastructure --> Repository[Repository]
Repository --> HrevolveDbContext
Infrastructure --> TenantResolver[TenantResolver]
TenantResolver --> HrevolveDbContext
TenantResolver --> Shared
```

**图表来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)

**本节来源**  
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
- [Repository.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Repositories/Repository.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)

## 性能考虑
基础设施层通过多种机制优化性能，包括Redis缓存、数据库连接池和查询优化。租户解析结果被缓存30分钟，减少数据库查询压力。

**本节来源**  
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs#L18)
- [appsettings.json](file://Backend/Hrevolve.Web/appsettings.json#L4)

## 故障排除指南
当遇到多租户相关问题时，应首先检查租户中间件的执行流程。确保租户标识能正确解析，并且租户上下文被正确设置。

**本节来源**  
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L132)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs#L13-L107)

## 结论
基础设施层成功实现了领域层定义的接口，为Hrevolve系统提供了稳定的数据持久化和多租户支持。通过EF Core的全局查询过滤器，实现了无缝的多租户数据隔离。仓储模式的通用实现降低了代码重复，提高了开发效率。整体设计遵循了关注点分离原则，为系统的可维护性和可扩展性奠定了坚实基础。