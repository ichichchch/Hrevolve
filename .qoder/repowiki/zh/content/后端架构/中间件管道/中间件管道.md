# 中间件管道

<cite>
**本文档中引用的文件**   
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs)
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs)
- [CurrentUserMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/CurrentUserMiddleware.cs)
- [ExceptionHandlingMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/ExceptionHandlingMiddleware.cs)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs)
- [ICurrentUser.cs](file://Backend/Hrevolve.Shared/Identity/ICurrentUser.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)
- [RequirePermissionAttribute.cs](file://Backend/Hrevolve.Web/Filters/RequirePermissionAttribute.cs)
- [appsettings.json](file://Backend/Hrevolve.Web/appsettings.json)
- [AuthController.cs](file://Backend/Hrevolve.Web/Controllers/AuthController.cs)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs)
</cite>

## 目录
1. [简介](#简介)
2. [中间件执行顺序](#中间件执行顺序)
3. [核心中间件分析](#核心中间件分析)
4. [内置中间件配置策略](#内置中间件配置策略)
5. [自定义中间件开发指南](#自定义中间件开发指南)
6. [异常处理流程](#异常处理流程)
7. [中间件依赖关系](#中间件依赖关系)
8. [最佳实践](#最佳实践)

## 简介
Hrevolve系统采用基于.NET的中间件管道架构，实现了多租户、身份认证、权限控制等核心功能。本系统通过精心设计的中间件执行顺序，确保了请求处理的正确性和安全性。中间件管道不仅实现了标准的HTTP处理流程，还集成了SaaS特有的多租户支持和全局异常处理机制。

## 中间件执行顺序
根据Program.cs中的配置，中间件按照特定顺序执行，每个中间件在管道中扮演特定角色：

```mermaid
flowchart TD
A["请求进入"] --> B["UseCors"]
B --> C["Use(async) - Alt-Svc"]
C --> D["UseMiddleware<ExceptionHandlingMiddleware>"]
D --> E["UseHttpsRedirection"]
E --> F["UseAuthentication"]
F --> G["UseAuthorization"]
G --> H["UseMiddleware<TenantMiddleware>"]
H --> I["UseMiddleware<CurrentUserMiddleware>"]
I --> J["MapControllers"]
J --> K["控制器执行"]
K --> L["响应返回"]
```

**Diagram sources**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L132-L155)

**Section sources**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L122-L155)

## 核心中间件分析

### TenantMiddleware分析
TenantMiddleware负责解析和设置租户上下文，是多租户架构的核心组件。该中间件优先从JWT令牌中提取租户信息，确保已认证用户的租户上下文正确设置。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant TM as "TenantMiddleware"
participant TC as "ITenantContextAccessor"
participant TR as "ITenantResolver"
Client->>TM : HTTP请求
TM->>TM : 检查排除路径
alt 路径被排除
TM->>Client : 继续执行管道
else 需要租户解析
TM->>TM : 从JWT提取tenant_id
alt JWT中存在tenant_id
TM->>TR : GetByIdAsync(tenantId)
TR-->>TM : 返回TenantInfo
TM->>TC : 设置TenantContext
else 从请求解析
TM->>TM : 从Header/Subdomain/Query解析标识
TM->>TR : ResolveAsync(identifier)
TR-->>TM : 返回TenantInfo
TM->>TC : 设置TenantContext
end
TM->>Client : 继续执行管道
TM->>TC : 清理TenantContext
end
```

**Diagram sources**
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L21-L94)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs#L38-L81)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs#L29-L56)

**Section sources**
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L133)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs#L6-L81)

### CurrentUserMiddleware分析
CurrentUserMiddleware从JWT令牌中解析用户身份信息，并设置当前用户上下文，为后续的业务逻辑提供用户信息。

```mermaid
classDiagram
class CurrentUserMiddleware {
+InvokeAsync(HttpContext, ICurrentUserAccessor)
-BuildCurrentUser(ClaimsPrincipal)
}
class CurrentUser {
+Guid? Id
+string? UserName
+string? Email
+Guid? TenantId
+Guid? EmployeeId
+IEnumerable~string~ Roles
+IEnumerable~string~ Permissions
+bool IsAuthenticated()
+bool HasPermission(string)
+bool IsInRole(string)
}
class ICurrentUserAccessor {
+ICurrentUser? CurrentUser
}
CurrentUserMiddleware --> CurrentUser : "创建"
CurrentUserMiddleware --> ICurrentUserAccessor : "依赖"
ICurrentUserAccessor --> CurrentUser : "持有"
```

**Diagram sources**
- [CurrentUserMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/CurrentUserMiddleware.cs#L9-L25)
- [ICurrentUser.cs](file://Backend/Hrevolve.Shared/Identity/ICurrentUser.cs#L70-L115)

**Section sources**
- [CurrentUserMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/CurrentUserMiddleware.cs#L6-L58)
- [ICurrentUser.cs](file://Backend/Hrevolve.Shared/Identity/ICurrentUser.cs#L6-L115)

## 内置中间件配置策略

### CORS配置
CORS中间件配置了允许所有来源的策略，确保前端应用能够正常访问API。

```mermaid
flowchart TD
A["CORS策略配置"] --> B["AllowAll策略"]
B --> C["AllowAnyOrigin"]
B --> D["AllowAnyMethod"]
B --> E["AllowAnyHeader"]
F["执行顺序"] --> G["在其他中间件之前"]
```

**Section sources**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L90-L99)

### 认证与授权配置
系统采用JWT Bearer认证方案，配置了严格的令牌验证参数。

```mermaid
flowchart TD
A["JWT认证配置"] --> B["TokenValidationParameters"]
B --> C["ValidateIssuer: true"]
B --> D["ValidateAudience: true"]
B --> E["ValidateLifetime: true"]
B --> F["ValidateIssuerSigningKey: true"]
G["认证流程"] --> H["UseAuthentication"]
G --> I["UseAuthorization"]
```

**Section sources**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L70-L88)

## 自定义中间件开发指南
创建自定义中间件需要遵循特定模式，确保与现有管道兼容。

```mermaid
flowchart TD
A["创建中间件类"] --> B["构造函数注入依赖"]
B --> C["实现InvokeAsync方法"]
C --> D["执行前置逻辑"]
D --> E["await next(context)"]
E --> F["执行后置逻辑"]
F --> G["异常处理"]
G --> H["实现IDisposable(如需要)"]
```

**Section sources**
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L133)
- [CurrentUserMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/CurrentUserMiddleware.cs#L6-L58)

## 异常处理流程
ExceptionHandlingMiddleware实现了全局异常捕获和标准化错误响应。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant EHM as "ExceptionHandlingMiddleware"
participant Logger as "Serilog"
Client->>EHM : 发送请求
EHM->>EHM : try { await next() }
alt 发生异常
EHM->>EHM : 捕获Exception
alt ValidationException
EHM->>EHM : 设置400状态码
EHM->>EHM : 构建验证错误响应
else EntityNotFoundException
EHM->>EHM : 设置404状态码
EHM->>EHM : 构建未找到响应
else UnauthorizedException
EHM->>EHM : 设置401状态码
EHM->>EHM : 构建未授权响应
else 其他HrevolveException
EHM->>EHM : 设置400状态码
EHM->>EHM : 构建业务错误响应
else 其他异常
EHM->>Logger : 记录错误日志
EHM->>EHM : 设置500状态码
EHM->>EHM : 构建内部错误响应
end
EHM->>Client : 返回JSON错误响应
else 无异常
EHM->>Client : 返回正常响应
end
```

**Diagram sources**
- [ExceptionHandlingMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/ExceptionHandlingMiddleware.cs#L9-L85)
- [HrevolveException.cs](file://Backend/Hrevolve.Shared/Exceptions/HrevolveException.cs#L6-L101)

**Section sources**
- [ExceptionHandlingMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/ExceptionHandlingMiddleware.cs#L6-L97)

## 中间件依赖关系
各中间件之间存在明确的依赖关系，执行顺序至关重要。

```mermaid
graph TD
A[CORS] --> B[Alt-Svc]
B --> C[ExceptionHandling]
C --> D[HttpsRedirection]
D --> E[Authentication]
E --> F[Authorization]
F --> G[TenantMiddleware]
G --> H[CurrentUserMiddleware]
H --> I[Controllers]
style A fill:#f9f,stroke:#333
style B fill:#f9f,stroke:#333
style C fill:#f96,stroke:#333
style D fill:#bbf,stroke:#333
style E fill:#6f9,stroke:#333
style F fill:#6f9,stroke:#333
style G fill:#f66,stroke:#333
style H fill:#f66,stroke:#333
style I fill:#66f,stroke:#333
```

**Diagram sources**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L132-L155)

**Section sources**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L122-L155)

## 最佳实践

### 多租户上下文管理
使用AsyncLocal确保租户上下文在异步操作中正确传递。

```mermaid
classDiagram
class TenantContextAccessor {
-static AsyncLocal~TenantContextHolder~
+ITenantContext? TenantContext
}
class TenantContextHolder {
+ITenantContext? Context
}
class AsyncLocal~T~ {
+T? Value
}
TenantContextAccessor --> TenantContextHolder : "持有"
TenantContextHolder --> ITenantContext : "引用"
TenantContextAccessor --> AsyncLocal~TenantContextHolder~ : "使用"
```

**Section sources**
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs#L54-L81)

### 权限验证机制
通过自定义过滤器实现细粒度的权限控制。

```mermaid
sequenceDiagram
participant Controller as "控制器"
participant Filter as "RequirePermissionAttribute"
participant User as "ICurrentUser"
Controller->>Filter : OnAuthorization
Filter->>Filter : 获取ICurrentUserAccessor
Filter->>User : 检查IsAuthenticated
alt 未认证
Filter->>Controller : 返回401
else 已认证
Filter->>User : 检查权限
alt 拥有权限
Filter->>Controller : 继续执行
else 无权限
Filter->>Controller : 返回403
end
end
```

**Diagram sources**
- [RequirePermissionAttribute.cs](file://Backend/Hrevolve.Web/Filters/RequirePermissionAttribute.cs#L33-L78)
- [ICurrentUser.cs](file://Backend/Hrevolve.Shared/Identity/ICurrentUser.cs#L51-L57)

**Section sources**
- [RequirePermissionAttribute.cs](file://Backend/Hrevolve.Web/Filters/RequirePermissionAttribute.cs#L6-L80)
- [ICurrentUser.cs](file://Backend/Hrevolve.Shared/Identity/ICurrentUser.cs#L6-L115)