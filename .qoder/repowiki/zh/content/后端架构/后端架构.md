# 后端架构

<cite>
**本文档引用的文件**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs)
- [DependencyInjection.cs](file://Backend/Hrevolve.Application/DependencyInjection.cs)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs)
- [Tenant.cs](file://Backend/Hrevolve.Domain/Tenants/Tenant.cs)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs)
- [LoggingBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/LoggingBehavior.cs)
- [ValidationBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/ValidationBehavior.cs)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs)
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs)
- [ExceptionHandlingMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/ExceptionHandlingMiddleware.cs)
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs)
- [LoginCommand.cs](file://Backend/Hrevolve.Application/Identity/Commands/LoginCommand.cs)
- [CreateLeaveRequestCommand.cs](file://Backend/Hrevolve.Application/Leave/Commands/CreateLeaveRequestCommand.cs)
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [分层架构设计](#分层架构设计)
3. [服务注册与依赖注入](#服务注册与依赖注入)
4. [中间件管道配置](#中间件管道配置)
5. [CQRS模式与MediatR应用](#cqrs模式与mediatr应用)
6. [行为过滤器机制](#行为过滤器机制)
7. [多租户上下文传播](#多租户上下文传播)
8. [数据库上下文与全局过滤器](#数据库上下文与全局过滤器)

## 项目结构

Hrevolve后端采用Clean Architecture分层设计，包含多个核心项目：

- **Hrevolve.Domain**：领域层，定义核心实体、值对象和业务规则
- **Hrevolve.Application**：应用层，处理用例逻辑，实现CQRS模式
- **Hrevolve.Infrastructure**：基础设施层，负责数据持久化和外部服务集成
- **Hrevolve.Web**：Web层，暴露API接口并配置中间件管道
- **Hrevolve.Shared**：共享层，包含跨层使用的接口和异常定义

```mermaid
graph TD
A["Web层<br/>API控制器、中间件"] --> B["应用层<br/>CQRS、MediatR、行为过滤器"]
B --> C["领域层<br/>实体、业务规则"]
B --> D["基础设施层<br/>数据库、缓存、仓储"]
D --> E["共享层<br/>ITenantContext、ICurrentUser"]
```

**图示来源**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L1-L173)
- [DependencyInjection.cs](file://Backend/Hrevolve.Application/DependencyInjection.cs#L1-L26)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs#L1-L58)

## 分层架构设计

Hrevolve采用Clean Architecture分层设计，各层职责分明，通过依赖注入实现松耦合。

### 领域层（Domain）

领域层定义了系统的核心实体和业务规则，如`Employee`、`Tenant`、`LeaveRequest`等。所有实体都继承自`AuditableEntity`，包含创建/更新时间、用户和租户ID等审计信息。

```mermaid
classDiagram
class Tenant {
+string Name
+string Code
+string? Domain
+TenantStatus Status
+TenantPlan Plan
+DateTime CreatedAt
+Create(name, code, plan) Tenant
+SetDomain(domain) void
+Suspend() void
+Activate() void
}
class Employee {
+string EmployeeNumber
+string FirstName
+string LastName
+DateOnly DateOfBirth
+DateOnly HireDate
+Guid? DirectManagerId
+Create(tenantId, employeeNumber, firstName, lastName, gender, dateOfBirth, hireDate) Employee
+SetContactInfo(email, phone, address, emergencyContact) void
+SetDirectManager(managerId) void
}
class LeaveRequest {
+Guid LeaveTypeId
+DateOnly StartDate
+DateOnly EndDate
+string Reason
+LeaveRequestStatus Status
+Create(tenantId, employeeId, leaveTypeId, startDate, endDate, startDayPart, endDayPart, reason) LeaveRequest
+Approve(approverId) void
+Reject(rejectorId) void
+Cancel(cancelerId) void
}
Tenant "1" -- "0..*" Employee : 拥有
Employee "1" -- "0..*" LeaveRequest : 提交
```

**图示来源**
- [Tenant.cs](file://Backend/Hrevolve.Domain/Tenants/Tenant.cs#L1-L67)
- [Employee.cs](file://Backend/Hrevolve.Domain/Employees/Employee.cs)
- [LeaveRequest.cs](file://Backend/Hrevolve.Domain/Leave/LeaveRequest.cs)

### 应用层（Application）

应用层采用CQRS模式，将命令（Commands）和查询（Queries）分离。通过MediatR实现请求处理管道，包含验证、日志等行为过滤器。

```mermaid
flowchart TD
A["API控制器"] --> B["MediatR Send<br/>命令/查询"]
B --> C["ValidationBehavior<br/>验证请求"]
C --> D["LoggingBehavior<br/>记录日志"]
D --> E["命令/查询处理器"]
E --> F["返回结果"]
```

**图示来源**
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs#L1-L136)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs#L1-L158)
- [LoginCommand.cs](file://Backend/Hrevolve.Application/Identity/Commands/LoginCommand.cs#L1-L177)

### 基础设施层（Infrastructure）

基础设施层实现数据持久化，包含`HrevolveDbContext`、仓储模式和多租户解析器。使用Entity Framework Core进行数据库操作，并通过全局查询过滤器实现多租户数据隔离。

### Web层（Web）

Web层负责暴露API接口，配置中间件管道，处理HTTP请求和响应。包含认证、授权、异常处理和多租户解析等中间件。

## 服务注册与依赖注入

### 应用层服务注册

应用层通过`AddApplication`扩展方法注册服务，主要包含MediatR和FluentValidation。

```mermaid
sequenceDiagram
participant Program as Program.cs
participant AppDI as AddApplication
participant MediatR as MediatR
participant Validator as FluentValidation
Program->>AppDI : builder.Services.AddApplication()
AppDI->>MediatR : AddMediatR()
MediatR->>MediatR : RegisterServicesFromAssembly()
MediatR->>MediatR : AddBehavior(ValidationBehavior)
MediatR->>MediatR : AddBehavior(LoggingBehavior)
AppDI->>Validator : AddValidatorsFromAssembly()
AppDI-->>Program : 返回IServiceCollection
```

**图示来源**
- [DependencyInjection.cs](file://Backend/Hrevolve.Application/DependencyInjection.cs#L1-L26)
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L102)

### 基础设施层服务注册

基础设施层通过`AddInfrastructure`扩展方法注册服务，包括数据库上下文、Redis缓存、多租户组件和仓储。

```mermaid
sequenceDiagram
participant Program as Program.cs
participant InfraDI as AddInfrastructure
participant DbContext as HrevolveDbContext
participant Redis as Redis缓存
participant Tenant as 多租户组件
participant Repository as 仓储
Program->>InfraDI : builder.Services.AddInfrastructure()
InfraDI->>DbContext : AddDbContext<HrevolveDbContext>()
InfraDI->>Redis : AddStackExchangeRedisCache()
InfraDI->>Tenant : AddSingleton<ITenantContextAccessor>()
InfraDI->>Tenant : AddScoped<ITenantResolver>()
InfraDI->>Repository : AddScoped<IRepository<T>, Repository<T>>()
InfraDI->>Repository : AddScoped<IEmployeeRepository>()
InfraDI->>Repository : AddScoped<IUserRepository>()
InfraDI-->>Program : 返回IServiceCollection
```

**图示来源**
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs#L1-L58)
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L103)

## 中间件管道配置

`Program.cs`中的中间件管道配置遵循特定顺序，确保正确处理请求。

```mermaid
flowchart TD
A["HTTP请求"] --> B["CORS中间件"]
B --> C["Alt-Svc头添加"]
C --> D["异常处理中间件"]
D --> E["HTTPS重定向"]
E --> F["认证中间件"]
F --> G["授权中间件"]
G --> H["租户中间件"]
H --> I["当前用户中间件"]
I --> J["控制器路由"]
J --> K["HTTP响应"]
style D stroke:#f66,stroke-width:2px
style H stroke:#66f,stroke-width:2px
style I stroke:#6f6,stroke-width:2px
```

**图示来源**
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L121-L155)
- [ExceptionHandlingMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/ExceptionHandlingMiddleware.cs#L1-L105)
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L1-L142)

### 中间件执行顺序与作用

1. **CORS中间件**：允许跨域请求，必须在其他中间件之前
2. **Alt-Svc头添加**：通知客户端支持HTTP/3
3. **异常处理中间件**：捕获全局异常，返回标准化错误响应
4. **HTTPS重定向**：将HTTP请求重定向到HTTPS
5. **认证中间件**：验证JWT令牌，设置用户身份
6. **授权中间件**：检查用户权限
7. **租户中间件**：解析并设置租户上下文
8. **当前用户中间件**：设置当前用户信息
9. **控制器路由**：映射到相应的API控制器

## CQRS模式与MediatR应用

### 命令处理流程

以创建员工为例，展示CQRS命令处理流程：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Controller as EmployeesController
participant MediatR as MediatR
participant Validation as ValidationBehavior
participant Logging as LoggingBehavior
participant Handler as CreateEmployeeCommandHandler
participant Repository as EmployeeRepository
participant DbContext as HrevolveDbContext
Client->>Controller : POST /api/employees
Controller->>MediatR : Send(CreateEmployeeCommand)
MediatR->>Validation : 执行验证
Validation-->>MediatR : 验证通过
MediatR->>Logging : 记录开始日志
Logging-->>MediatR : 继续
MediatR->>Handler : 调用Handle方法
Handler->>Repository : GetByEmployeeNumberAsync()
Repository-->>Handler : 返回结果
Handler->>Repository : AddAsync(employee)
Handler->>DbContext : SaveChangesAsync()
DbContext-->>Handler : 保存成功
Handler-->>MediatR : 返回Result<Guid>
MediatR->>Logging : 记录完成日志
Logging-->>MediatR : 继续
MediatR-->>Controller : 返回结果
Controller-->>Client : 返回响应
```

**图示来源**
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs#L1-L136)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs)

### 查询处理流程

以获取员工详情为例，展示CQRS查询处理流程：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Controller as EmployeesController
participant MediatR as MediatR
participant Validation as ValidationBehavior
participant Logging as LoggingBehavior
participant Handler as GetEmployeeQueryHandler
participant Repository as EmployeeRepository
Client->>Controller : GET /api/employees/{id}
Controller->>MediatR : Send(GetEmployeeQuery)
MediatR->>Validation : 执行验证
Validation-->>MediatR : 验证通过
MediatR->>Logging : 记录开始日志
Logging-->>MediatR : 继续
MediatR->>Handler : 调用Handle方法
Handler->>Repository : GetByIdAsync(id)
Repository-->>Handler : 返回Employee
Handler->>Repository : GetJobHistoryAtDateAsync()
Repository-->>Handler : 返回JobHistory
Handler-->>MediatR : 返回Result<EmployeeDto>
MediatR->>Logging : 记录完成日志
Logging-->>MediatR : 继续
MediatR-->>Controller : 返回结果
Controller-->>Client : 返回响应
```

**图示来源**
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs#L1-L158)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs)

## 行为过滤器机制

### 验证行为过滤器

`ValidationBehavior`在命令/查询处理前自动执行FluentValidation验证。

```mermaid
flowchart TD
A["请求"] --> B{"验证器存在?"}
B --> |否| C["继续处理"]
B --> |是| D["创建ValidationContext"]
D --> E["并行执行所有验证器"]
E --> F{"验证失败?"}
F --> |否| C
F --> |是| G["收集错误信息"]
G --> H["抛出ValidationException"]
C --> I["继续管道"]
```

**图示来源**
- [ValidationBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/ValidationBehavior.cs#L1-L49)
- [CreateEmployeeCommandValidator.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs#L29-L65)

### 日志行为过滤器

`LoggingBehavior`记录请求处理的开始、完成和异常信息。

```mermaid
flowchart TD
A["请求开始"] --> B["记录开始日志"]
B --> C["启动计时器"]
C --> D["执行后续处理"]
D --> E{"处理成功?"}
E --> |是| F["停止计时器"]
F --> G["记录完成日志"]
G --> H["返回结果"]
E --> |否| I["停止计时器"]
I --> J["记录错误日志"]
J --> K["重新抛出异常"]
```

**图示来源**
- [LoggingBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/LoggingBehavior.cs#L1-L59)

## 多租户上下文传播

### 租户上下文接口

`ITenantContext`定义了租户上下文的基本接口，`ITenantContextAccessor`用于设置和获取上下文。

```mermaid
classDiagram
class ITenantContext {
+Guid TenantId
+string? TenantCode
+bool HasTenant
}
class ITenantContextAccessor {
+ITenantContext? TenantContext
}
class TenantContext {
-Guid _tenantId
-string? _tenantCode
+Guid TenantId
+string? TenantCode
+bool HasTenant
+TenantContext(tenantId, tenantCode)
}
class TenantContextAccessor {
-AsyncLocal<TenantContextHolder> _tenantContextCurrent
+ITenantContext? TenantContext
}
ITenantContext <|-- TenantContext
ITenantContextAccessor <|-- TenantContextAccessor
```

**图示来源**
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs#L1-L81)

### 租户解析流程

租户中间件解析租户的完整流程：

```mermaid
sequenceDiagram
participant Middleware as TenantMiddleware
participant Resolver as TenantResolver
participant Cache as Redis缓存
participant DB as 数据库
Middleware->>Middleware : 检查排除路径
alt 路径被排除
Middleware-->>Middleware : 跳过租户解析
else 需要租户
Middleware->>Middleware : 从JWT获取tenant_id
alt JWT中有tenant_id
Middleware->>Resolver : GetByIdAsync(tenantId)
Resolver->>Cache : 尝试从缓存获取
alt 缓存命中
Cache-->>Resolver : 返回缓存数据
else 缓存未命中
Resolver->>DB : 查询数据库
DB-->>Resolver : 返回租户信息
Resolver->>Cache : 缓存结果
end
Resolver-->>Middleware : 返回TenantInfo
Middleware->>Middleware : 验证租户状态
alt 租户有效
Middleware->>Middleware : 设置租户上下文
else 租户无效
Middleware->>Middleware : 抛出TenantException
end
else 无JWT tenant_id
Middleware->>Middleware : 从请求解析租户标识
Middleware->>Resolver : ResolveAsync(identifier)
Resolver->>Cache : 尝试从缓存获取
alt 缓存命中
Cache-->>Resolver : 返回缓存数据
else 缓存未命中
Resolver->>DB : 查询数据库
DB-->>Resolver : 返回租户信息
Resolver->>Cache : 缓存结果
end
Resolver-->>Middleware : 返回TenantInfo
Middleware->>Middleware : 验证租户状态
alt 租户有效
Middleware->>Middleware : 设置租户上下文
else 租户无效
Middleware->>Middleware : 抛出TenantException
end
end
end
```

**图示来源**
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L1-L142)
- [TenantResolver.cs](file://Backend/Hrevolve.Infrastructure/MultiTenancy/TenantResolver.cs#L1-L108)

### 租户标识解析优先级

租户中间件按照以下优先级解析租户标识：

1. **Header**：`X-Tenant-Id` 请求头
2. **子域名**：`tenant.example.com` 的子域名部分
3. **查询参数**：`?tenant=code` 的查询参数

## 数据库上下文与全局过滤器

### HrevolveDbContext设计

`HrevolveDbContext`通过依赖注入获取`ITenantContextAccessor`和`ICurrentUserAccessor`，实现多租户和审计功能。

```mermaid
classDiagram
class HrevolveDbContext {
-ITenantContextAccessor _tenantContextAccessor
-ICurrentUserAccessor _currentUserAccessor
+DbSet<Tenant> Tenants
+DbSet<Employee> Employees
+DbSet<User> Users
+OnModelCreating(ModelBuilder)
+SaveChangesAsync()
-ConfigureTenantFilter(ModelBuilder)
-ConfigureSoftDeleteFilter(ModelBuilder)
}
HrevolveDbContext --> ITenantContextAccessor : 依赖
HrevolveDbContext --> ICurrentUserAccessor : 依赖
```

**图示来源**
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L1-L157)

### 全局查询过滤器

`HrevolveDbContext`实现了两个全局查询过滤器：

1. **多租户过滤器**：确保查询只返回当前租户的数据
2. **软删除过滤器**：自动过滤已删除的记录

```mermaid
flowchart TD
A["查询Employees"] --> B["应用全局过滤器"]
B --> C["添加租户过滤条件"]
C --> D["添加软删除过滤条件"]
D --> E["执行最终查询"]
E --> F["返回结果"]
style C stroke:#f66,stroke-width:2px
style D stroke:#66f,stroke-width:2px
```

当执行 `context.Employees.ToList()` 时，实际生成的SQL包含：
```sql
WHERE "TenantId" = @tenantId AND "IsDeleted" = FALSE
```

**图示来源**
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L77-L118)

### 实体状态跟踪与审计

`SaveChangesAsync`重写方法在保存更改时自动设置审计字段：

```mermaid
flowchart TD
A["SaveChangesAsync"] --> B["遍历变更跟踪中的实体"]
B --> C{"实体状态"}
C --> |Added| D["设置CreatedAt、CreatedBy、TenantId"]
C --> |Modified| E["设置UpdatedAt、UpdatedBy"]
C --> |Deleted| F["改为Modified，设置IsDeleted、DeletedAt、DeletedBy"]
D --> G["保存到数据库"]
E --> G
F --> G
G --> H["返回结果"]
```

**图示来源**
- [HrevolveDbContext.cs](file://Backend/Hrevolve.Infrastructure/Persistence/HrevolveDbContext.cs#L120-L155)