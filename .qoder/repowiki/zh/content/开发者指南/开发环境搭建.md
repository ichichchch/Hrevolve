# 开发环境搭建

<cite>
**本文档引用文件**  
- [README.md](file://README.md)
- [Backend/README.md](file://Backend/README.md)
- [Frontend/README.md](file://Frontend/README.md)
- [Backend/Hrevolve.Web/appsettings.json](file://Backend/Hrevolve.Web/appsettings.json)
- [Backend/Hrevolve.Web/appsettings.Development.json](file://Backend/Hrevolve.Web/appsettings.Development.json)
- [Backend/Hrevolve.Web/Program.cs](file://Backend/Hrevolve.Web/Program.cs)
- [Backend/Hrevolve.Web/Properties/launchSettings.json](file://Backend/Hrevolve.Web/Properties/launchSettings.json)
- [Frontend/hrevolve-web/.env.development](file://Frontend/hrevolve-web/.env.development)
- [Frontend/hrevolve-web/vite.config.ts](file://Frontend/hrevolve-web/vite.config.ts)
- [Backend/Hrevolve.Infrastructure/Migrations/20251227093819_InitialCreate.cs](file://Backend/Hrevolve.Infrastructure/Migrations/20251227093819_InitialCreate.cs)
- [Backend/Hrevolve.Agent/DependencyInjection.cs](file://Backend/Hrevolve.Agent/DependencyInjection.cs)
- [Design/Agent.md](file://Design/Agent.md)
</cite>

## 目录
1. [环境要求](#环境要求)
2. [代码库克隆与依赖还原](#代码库克隆与依赖还原)
3. [后端配置](#后端配置)
4. [前端配置](#前端配置)
5. [数据库迁移](#数据库迁移)
6. [常见错误处理](#常见错误处理)
7. [前后端并行启动流程](#前后端并行启动流程)
8. [服务可达性验证](#服务可达性验证)

## 环境要求

本项目依赖以下技术栈，请确保在本地开发环境中正确安装并配置：

- **.NET 10 SDK**：后端服务基于 .NET 10 构建，需安装 .NET 10 Preview SDK。
- **Node.js 18+**：前端项目使用 Vite 构建工具，需 Node.js 18 或更高版本。
- **PostgreSQL 16**：作为主数据库，用于存储业务数据。
- **Redis 7**：用于缓存和会话管理。

**Section sources**
- [README.md](file://README.md#L108-L111)

## 代码库克隆与依赖还原

### 克隆代码库

打开终端，执行以下命令克隆项目代码：

```bash
git clone https://github.com/your-organization/Hrevolve.git
cd Hrevolve
```

### 还原 NuGet 依赖包

进入后端目录，还原 .NET 项目的 NuGet 依赖：

```bash
cd Backend
dotnet restore
```

### 安装 npm 依赖包

进入前端目录，安装 Node.js 依赖：

```bash
cd ../Frontend/hrevolve-web
npm install
```

**Section sources**
- [README.md](file://README.md#L118-L135)

## 后端配置

### 配置文件说明

后端配置文件位于 `Backend/Hrevolve.Web/` 目录下：

- `appsettings.json`：基础配置文件，包含默认连接字符串和 JWT 配置。
- `appsettings.Development.json`：开发环境配置文件，覆盖基础配置。

### 数据库连接字符串配置

修改 `appsettings.Development.json` 中的 `ConnectionStrings` 配置：

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=hrevolve_dev;Username=postgres;Password=123456",
    "Redis": "localhost:6379"
  }
}
```

请根据实际 PostgreSQL 和 Redis 服务地址、端口、用户名和密码进行调整。

### AI 服务密钥配置

系统集成 Microsoft Agent Framework，支持 OpenAI、Azure 等提供商。在 `appsettings.Development.json` 中配置 AI 服务：

```json
{
  "AI": {
    "Provider": "OpenAI",
    "ApiKey": "your-openai-api-key",
    "Model": "gpt-4o"
  }
}
```

若不配置 AI 服务，系统将使用模拟客户端，AI 助手功能将返回预设响应。

**Section sources**
- [Backend/README.md](file://Backend/README.md#L62-L63)
- [Backend/Hrevolve.Web/appsettings.json](file://Backend/Hrevolve.Web/appsettings.json#L2-L5)
- [Backend/Hrevolve.Web/appsettings.Development.json](file://Backend/Hrevolve.Web/appsettings.Development.json#L2-L5)
- [Design/Agent.md](file://Design/Agent.md#L220-L230)

## 前端配置

### 环境变量文件

前端项目使用 Vite 环境变量，配置文件位于 `Frontend/hrevolve-web/` 目录下：

- `.env.development`：开发环境变量
- `.env.production`：生产环境变量

### 配置 API 基础路径

`.env.development` 文件中已配置 API 代理路径：

```env
VITE_API_BASE_URL=/api
```

Vite 开发服务器会将 `/api` 请求代理到后端服务。代理配置在 `vite.config.ts` 中定义：

```ts
proxy: {
  '/api': {
    target: 'https://localhost:5225',
    changeOrigin: true,
    secure: false
  }
}
```

**Section sources**
- [Frontend/README.md](file://Frontend/README.md#L70-L75)
- [Frontend/hrevolve-web/.env.development](file://Frontend/hrevolve-web/.env.development#L3)
- [Frontend/hrevolve-web/vite.config.ts](file://Frontend/hrevolve-web/vite.config.ts#L15-L19)

## 数据库迁移

### 执行数据库迁移命令

在后端项目目录下执行以下命令创建并应用数据库迁移：

```bash
# 创建初始迁移
dotnet ef migrations add InitialCreate -p Hrevolve.Infrastructure -s Hrevolve.Web

# 应用迁移到数据库
dotnet ef database update -p Hrevolve.Infrastructure -s Hrevolve.Web
```

### 迁移命令参数说明

- `-p Hrevolve.Infrastructure`：指定迁移项目（包含 `DbContext` 的项目）。
- `-s Hrevolve.Web`：指定启动项目（包含配置和依赖注入的项目）。

迁移将根据 `Hrevolve.Infrastructure/Migrations` 目录下的迁移文件创建数据库表结构。

**Section sources**
- [README.md](file://README.md#L121-L124)
- [Backend/README.md](file://Backend/README.md#L71-L74)
- [Backend/Hrevolve.Infrastructure/Migrations/20251227093819_InitialCreate.cs](file://Backend/Hrevolve.Infrastructure/Migrations/20251227093819_InitialCreate.cs#L14-L800)

## 常见错误处理

### 端口冲突

后端服务默认使用以下端口：
- HTTP：`5224`
- HTTPS：`5225`

若端口被占用，可在 `Backend/Hrevolve.Web/Properties/launchSettings.json` 中修改：

```json
"applicationUrl": "http://localhost:5224"
```

或通过环境变量 `ASPNETCORE_URLS` 指定：

```bash
export ASPNETCORE_URLS="http://localhost:5000;https://localhost:5001"
```

### 权限不足

确保 PostgreSQL 用户具有创建数据库的权限。若使用 `postgres` 用户，密码需与配置文件一致。

### 数据库连接失败

检查以下配置：
- PostgreSQL 服务是否已启动
- 连接字符串中的主机、端口、数据库名、用户名、密码是否正确
- 防火墙是否阻止连接

### EF Core 工具未安装

若 `dotnet ef` 命令未找到，需全局安装 EF Core 工具：

```bash
dotnet tool install --global dotnet-ef
```

**Section sources**
- [Backend/Hrevolve.Web/Properties/launchSettings.json](file://Backend/Hrevolve.Web/Properties/launchSettings.json#L17-L28)
- [Backend/Hrevolve.Web/Program.cs](file://Backend/Hrevolve.Web/Program.cs#L4-L17)

## 前后端并行启动流程

### 启动后端服务

在 `Backend` 目录下运行：

```bash
dotnet run --project Hrevolve.Web
```

服务将启动并自动打开 Swagger 文档页面。

### 启动前端开发服务器

在 `Frontend/hrevolve-web` 目录下运行：

```bash
npm run dev
```

Vite 将启动开发服务器并监听 `http://localhost:5173`。

### 并行启动脚本（推荐）

可使用 `concurrently` 工具并行启动前后端：

```bash
# 安装 concurrently
npm install -g concurrently

# 在项目根目录执行
concurrently \
  "dotnet run --project Backend/Hrevolve.Web" \
  "cd Frontend/hrevolve-web && npm run dev"
```

**Section sources**
- [README.md](file://README.md#L126-L138)

## 服务可达性验证

### 验证后端服务

访问以下地址验证后端服务是否正常运行：
- API 文档：`https://localhost:5225/swagger`
- 健康检查：`https://localhost:5225/health`

返回 JSON 响应表示服务正常。

### 验证前端服务

访问 `http://localhost:5173`，应能看到前端登录页面。

### 验证 API 通信

登录前端后，发起任意 API 请求（如获取员工列表），通过浏览器开发者工具查看网络请求是否成功。

**Section sources**
- [README.md](file://README.md#L144-L148)
- [Backend/Hrevolve.Web/Program.cs](file://Backend/Hrevolve.Web/Program.cs#L157-L159)