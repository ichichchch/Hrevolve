# 业务模块扩展

<cite>
**本文档引用的文件**  
- [Tenant.cs](file://Backend/Hrevolve.Domain/Tenants/Tenant.cs)
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs)
- [ValueObject.cs](file://Backend/Hrevolve.Domain/Common/ValueObject.cs)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs)
- [Employee.cs](file://Backend/Hrevolve.Domain/Employees/Employee.cs)
- [JobHistory.cs](file://Backend/Hrevolve.Domain/Employees/JobHistory.cs)
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs)
- [index.ts](file://Frontend/hrevolve-web/src/router/index.ts)
- [employee.ts](file://Frontend/hrevolve-web/src/api/modules/employee.ts)
- [request.ts](file://Frontend/hrevolve-web/src/api/request.ts)
- [RequirePermissionAttribute.cs](file://Backend/Hrevolve.Web/Filters/RequirePermissionAttribute.cs)
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs)
</cite>

## 目录
1. [引言](#引言)
2. [领域模型设计](#领域模型设计)
3. [CQRS模式与命令查询定义](#cqrs模式与命令查询定义)
4. [EF Core配置映射](#ef-core配置映射)
5. [API控制器实现](#api控制器实现)
6. [前端集成流程](#前端集成流程)
7. [多租户上下文传播](#多租户上下文传播)

## 引言
本文档详细阐述在Hrevolve HR系统中新增业务模块的标准化流程。通过员工管理模块作为示例，全面介绍从领域模型设计、CQRS命令查询定义、EF Core映射配置、API控制器实现到前端集成的完整开发流程。特别强调多租户字段（TenantId）在各层的正确传播和使用，确保系统在SaaS架构下的数据隔离和安全性。

## 领域模型设计

在Hrevolve系统中，领域模型设计遵循领域驱动设计（DDD）原则，核心包括实体（Entity）、值对象（Value Object）和聚合根（Aggregate Root）的定义。

### 实体与聚合根
实体是具有唯一标识和生命周期的对象。在本系统中，所有实体都继承自`Entity`基类，而可审计实体则继承自`AuditableEntity`，后者包含了多租户隔离和审计字段。

`Employee`（员工）是员工管理模块的聚合根，它包含了员工的基本信息、联系方式、雇佣状态等核心属性。作为聚合根，`Employee`负责维护其内部一致性，并通过工厂方法`Create`来保证对象的合法创建。

```mermaid
classDiagram
class Entity {
+Guid Id
}
class AuditableEntity {
+Guid TenantId
+DateTime CreatedAt
+Guid? CreatedBy
+DateTime? UpdatedAt
+Guid? UpdatedBy
+bool IsDeleted
+DateTime? DeletedAt
+Guid? DeletedBy
}
class Employee {
+string EmployeeNumber
+string FirstName
+string LastName
+string FullName
+string? EnglishName
+Gender Gender
+DateOnly DateOfBirth
+string? Email
+string? Phone
+EmploymentStatus Status
+EmploymentType EmploymentType
+DateOnly HireDate
+DateOnly? TerminationDate
+Guid? DirectManagerId
+Employee? DirectManager
+IReadOnlyCollection<JobHistory> JobHistories
+static Employee Create(...)
+void SetContactInfo(...)
+void SetDirectManager(...)
+void Terminate(...)
}
class JobHistory {
+Guid EmployeeId
+Employee Employee
+DateOnly EffectiveStartDate
+DateOnly EffectiveEndDate
+Guid PositionId
+Guid DepartmentId
+decimal BaseSalary
+string? Grade
+JobChangeType ChangeType
+string? ChangeReason
+CorrectionStatus? CorrectionStatus
+Guid? CorrectionRefId
+static JobHistory Create(...)
+void Close(...)
+void Void(...)
+bool IsEffectiveOn(...)
}
AuditableEntity --|> Entity
Employee --|> AuditableEntity
JobHistory --|> AuditableEntity
Employee "1" *-- "0..*" JobHistory : 包含
Employee --> Employee : 直属上级
```

**图示来源**
- [Employee.cs](file://Backend/Hrevolve.Domain/Employees/Employee.cs#L6-L137)
- [JobHistory.cs](file://Backend/Hrevolve.Domain/Employees/JobHistory.cs#L9-L124)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs#L6-L48)

### 值对象
值对象是通过其属性值来定义的对象，没有唯一标识。在本系统中，所有值对象都继承自`ValueObject`基类，该基类提供了基于属性值的相等性比较。

虽然在当前示例中没有明确的值对象实现，但系统设计为支持值对象的创建。例如，可以将员工的联系方式（ContactInfo）设计为一个值对象，包含邮箱、电话、地址等属性。

```mermaid
classDiagram
class ValueObject {
+bool Equals(object obj)
+int GetHashCode()
+bool operator ==(ValueObject left, ValueObject right)
+bool operator !=(ValueObject left, ValueObject right)
+abstract IEnumerable<object?> GetEqualityComponents()
}
class ContactInfo {
+string? Email
+string? Phone
+string? Address
+string? PersonalEmail
}
ContactInfo --|> ValueObject
```

**图示来源**
- [ValueObject.cs](file://Backend/Hrevolve.Domain/Common/ValueObject.cs#L6-L33)

**本节来源**
- [ValueObject.cs](file://Backend/Hrevolve.Domain/Common/ValueObject.cs#L1-L33)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs#L1-L48)

## CQRS模式与命令查询定义

Hrevolve系统采用CQRS（命令查询职责分离）模式，将数据修改操作（命令）与数据读取操作（查询）完全分离，以提高系统的可维护性和性能。

### 命令定义与验证
命令用于表示对系统状态的修改操作。每个命令都是一个记录（record），实现`IRequest<Result<T>>`接口，其中`Result<T>`是系统统一的返回结果类型。

以`CreateEmployeeCommand`为例，它包含了创建员工所需的所有数据，并通过C#的`init`属性确保不可变性。

命令的验证通过FluentValidation库实现。每个命令都有对应的验证器（Validator），在命令处理前自动执行验证规则。

```mermaid
sequenceDiagram
participant Client as "前端客户端"
participant Controller as "EmployeesController"
participant Mediator as "MediatR"
participant Validator as "CreateEmployeeCommandValidator"
participant Handler as "CreateEmployeeCommandHandler"
participant Repository as "IEmployeeRepository"
participant DbContext as "HrevolveDbContext"
Client->>Controller : POST /api/employees
Controller->>Mediator : mediator.Send(command)
Mediator->>Validator : 自动验证
Validator-->>Mediator : 验证通过/失败
alt 验证失败
Mediator-->>Controller : 返回验证错误
Controller-->>Client : 400 Bad Request
else 验证成功
Mediator->>Handler : 调用Handle方法
Handler->>Repository : 检查员工编号是否已存在
Repository-->>Handler : 返回检查结果
alt 员工编号已存在
Handler-->>Mediator : 返回失败结果
else 员工编号可用
Handler->>Handler : 创建Employee实体
Handler->>Repository : 添加员工
Repository->>DbContext : 跟踪实体
Handler->>Handler : 创建JobHistory
Handler->>DbContext : 跟踪JobHistory
Handler->>DbContext : SaveChangesAsync()
DbContext-->>Handler : 事务提交
Handler-->>Mediator : 返回成功结果
end
Mediator-->>Controller : 返回结果
Controller-->>Client : 201 Created
end
```

**图示来源**
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs#L6-L126)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs#L54-L66)

### 查询定义与DTO
查询用于获取系统状态，不改变任何数据。查询返回的是DTO（数据传输对象），而不是领域实体，以实现关注点分离。

`GetEmployeeQuery`查询返回`EmployeeDto`，它是一个扁平化的数据结构，包含了员工的详细信息以及当前职位信息。这种设计避免了前端需要多次调用API来获取关联数据。

```mermaid
classDiagram
class GetEmployeeQuery {
+Guid EmployeeId
}
class EmployeeDto {
+Guid Id
+string EmployeeNumber
+string FullName
+string FirstName
+string LastName
+string? EnglishName
+string Gender
+DateOnly DateOfBirth
+string? Email
+string? Phone
+string Status
+string EmploymentType
+DateOnly HireDate
+DateOnly? TerminationDate
+Guid? DirectManagerId
+CurrentJobDto? CurrentJob
}
class CurrentJobDto {
+Guid PositionId
+Guid DepartmentId
+decimal BaseSalary
+string? Grade
+DateOnly EffectiveDate
}
GetEmployeeQuery --> EmployeeDto : 返回
EmployeeDto --> CurrentJobDto : 包含
```

**图示来源**
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs#L38-L146)

**本节来源**
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs#L6-L126)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs#L38-L146)

## EF Core配置映射

EF Core配置文件用于定义领域实体与数据库表之间的映射关系，包括表名、字段类型、索引和关系等。

### 表名与字段配置
`EmployeeConfiguration`类配置了`Employee`实体的映射。通过`ToTable`方法指定数据库表名为"Employees"，并为每个属性配置了适当的长度限制和约束。

```mermaid
erDiagram
EMPLOYEES {
uuid Id PK
uuid TenantId FK
string EmployeeNumber UK
string FirstName
string LastName
string EnglishName
string IdCardNumber
string Email
string Phone
string PersonalEmail
string Address
enum Status
enum EmploymentType
date DateOfBirth
date HireDate
date TerminationDate
uuid DirectManagerId FK
uuid UserId
timestamp CreatedAt
uuid CreatedBy
timestamp UpdatedAt
uuid UpdatedBy
bool IsDeleted
timestamp DeletedAt
uuid DeletedBy
}
JOB_HISTORIES {
uuid Id PK
uuid TenantId FK
uuid EmployeeId FK
date EffectiveStartDate
date EffectiveEndDate
uuid PositionId
uuid DepartmentId
decimal BaseSalary
string Grade
enum ChangeType
string ChangeReason
enum CorrectionStatus
uuid CorrectionRefId
timestamp CreatedAt
uuid CreatedBy
timestamp UpdatedAt
uuid UpdatedBy
bool IsDeleted
timestamp DeletedAt
uuid DeletedBy
}
EMPLOYEES ||--o{ JOB_HISTORIES : "1对多"
EMPLOYEES }o--|| EMPLOYEES : "自引用-直属上级"
```

**图示来源**
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs#L5-L110)

### 索引定义
索引对于查询性能至关重要。系统为关键查询路径定义了复合索引：

- `(TenantId, EmployeeNumber)`：确保租户内员工编号的唯一性，支持通过员工编号快速查找
- `(TenantId, Email)`：支持通过邮箱查找员工
- `(TenantId, Status)`：支持按状态筛选员工（如在职、离职）

对于`JobHistory`，定义了`(TenantId, EmployeeId, EffectiveStartDate, EffectiveEndDate)`索引，以支持高效的时点查询。

### 关系配置
实体间的关系通过`HasOne`、`HasMany`等方法配置。`Employee`与`JobHistory`之间是一对多关系，配置为级联删除（Cascade），确保删除员工时自动删除其所有职位历史记录。

`Employee`的`DirectManager`属性配置为自引用关系，使用`Restrict`删除行为，防止直接删除有下属的管理者。

**本节来源**
- [EmployeeConfiguration.cs](file://Backend/Hrevolve.Infrastructure/Persistence/Configurations/EmployeeConfiguration.cs#L5-L110)

## API控制器实现

API控制器是前后端交互的入口，负责接收HTTP请求、调用应用服务并返回响应。

### 路由设计
控制器使用属性路由进行精确控制。`EmployeesController`的基路径为`api/employees`，通过`[Route("api/[controller]")]`自动生成。

具体操作的路由设计遵循RESTful原则：
- `GET /api/employees/{id}`：获取指定员工详情
- `POST /api/employees`：创建新员工
- `PUT /api/employees/{id}`：更新员工信息
- `POST /api/employees/{id}/terminate`：员工离职（特定操作）

### 权限控制
权限控制通过自定义的`[RequirePermission]`特性实现。该特性实现了`IAuthorizationFilter`接口，在请求处理前检查用户权限。

```mermaid
flowchart TD
Start([请求进入]) --> CheckAuth["检查用户认证状态"]
CheckAuth --> AuthValid{"已认证?"}
AuthValid --> |否| Return401["返回401 Unauthorized"]
AuthValid --> |是| CheckAdmin["检查系统管理员权限"]
CheckAdmin --> IsAdmin{"是系统管理员?"}
IsAdmin --> |是| AllowAccess["允许访问"]
IsAdmin --> |否| CheckPermission["检查所需权限"]
CheckPermission --> HasPermission{"拥有权限?"}
HasPermission --> |否| Return403["返回403 Forbidden"]
HasPermission --> |是| AllowAccess
AllowAccess --> InvokeAction["调用控制器方法"]
Return401 --> End([响应返回])
Return403 --> End
InvokeAction --> End
```

**图示来源**
- [RequirePermissionAttribute.cs](file://Backend/Hrevolve.Web/Filters/RequirePermissionAttribute.cs#L7-L80)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs#L16-L17)

### MediatR请求分发
控制器通过MediatR库将请求分发给相应的命令或查询处理器。这种方式实现了请求处理的解耦，使控制器保持简洁。

```csharp
var result = await mediator.Send(new GetEmployeeQuery(id), cancellationToken);
```

MediatR会自动找到`GetEmployeeQueryHandler`并执行，同时触发验证行为（ValidationBehavior）和日志行为（LoggingBehavior）。

**本节来源**
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs#L9-L95)
- [RequirePermissionAttribute.cs](file://Backend/Hrevolve.Web/Filters/RequirePermissionAttribute.cs#L7-L80)

## 前端集成流程

前端集成包括路由注册、API客户端封装和视图组件开发三个主要步骤。

### 前端路由注册
前端使用Vue Router进行路由管理。新的业务模块需要在`router/index.ts`中注册路由。

```mermaid
flowchart TD
A[定义路由配置] --> B["routes: RouteRecordRaw[]"]
B --> C["path: '/employees'"]
C --> D["component: () => import('@/views/employees/EmployeeListView.vue')"]
D --> E["meta: { titleKey: 'menu.employees', icon: 'UserFilled', permission: 'employee:read' }"]
E --> F["children: [...]"]
F --> G["子路由: 员工列表、详情等"]
G --> H[创建路由实例]
H --> I["createRouter({ history, routes })"]
I --> J[添加路由守卫]
J --> K["router.beforeEach(...)"]
K --> L[权限检查]
L --> M[导航到目标页面]
```

**图示来源**
- [index.ts](file://Frontend/hrevolve-web/src/router/index.ts#L5-L368)

### API客户端封装
API客户端封装在`src/api/modules`目录下，每个业务模块有一个对应的TS文件。

`employee.ts`文件封装了所有员工管理相关的API调用，使用统一的`request`实例，自动处理认证和租户信息。

```mermaid
classDiagram
class request {
+get<T>(url, config)
+post<T>(url, data, config)
+put<T>(url, data, config)
+delete<T>(url, config)
+patch<T>(url, data, config)
}
class employeeApi {
+getList(params)
+getById(id)
+getAtDate(id, date)
+create(data)
+update(id, data)
+delete(id)
+getJobHistory(id)
+transfer(id, data)
+terminate(id, data)
}
employeeApi --> request : 使用
```

**图示来源**
- [employee.ts](file://Frontend/hrevolve-web/src/api/modules/employee.ts#L5-L51)
- [request.ts](file://Frontend/hrevolve-web/src/api/request.ts#L84-L104)

### 视图组件开发
视图组件位于`src/views`目录下，遵循一致的命名和结构规范。员工管理模块包含`EmployeeListView`和`EmployeeDetailView`等组件。

**本节来源**
- [index.ts](file://Frontend/hrevolve-web/src/router/index.ts#L5-L368)
- [employee.ts](file://Frontend/hrevolve-web/src/api/modules/employee.ts#L5-L51)
- [request.ts](file://Frontend/hrevolve-web/src/api/request.ts#L1-L107)

## 多租户上下文传播

多租户是Hrevolve系统的核心特性，TenantId在各层的正确传播和使用是确保数据隔离的关键。

### 租户上下文实现
`ITenantContext`接口定义了租户上下文的基本结构，包含`TenantId`和`TenantCode`。`TenantContextAccessor`使用`AsyncLocal`存储当前请求的租户上下文，确保在异步操作中也能正确传递。

```mermaid
classDiagram
class ITenantContext {
+Guid TenantId
+string? TenantCode
+bool HasTenant
}
class ITenantContextAccessor {
+ITenantContext? TenantContext
}
class TenantContext {
+Guid TenantId
+string? TenantCode
+bool HasTenant
}
class TenantContextAccessor {
+ITenantContext? TenantContext
}
ITenantContext <|-- TenantContext
ITenantContextAccessor <|-- TenantContextAccessor
```

**图示来源**
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs#L6-L81)

### 租户中间件
`TenantMiddleware`是租户解析的核心组件。它按照优先级从多个来源解析租户标识：

1. **JWT Token**：已认证用户的JWT中包含`tenant_id`声明
2. **Header**：`X-Tenant-Id`请求头
3. **Subdomain**：子域名（如`tenant1.example.com`）
4. **Query Parameter**：URL查询参数`tenant`

中间件在请求开始时设置租户上下文，在请求结束时清理，确保上下文不会泄漏到其他请求。

```mermaid
flowchart TD
Start([请求进入]) --> CheckExcluded["检查是否为排除路径"]
CheckExcluded --> IsExcluded{"是排除路径?"}
IsExcluded --> |是| CallNext["调用next()"]
IsExcluded --> |否| CheckJWT["检查JWT中的tenant_id"]
CheckJWT --> HasJWT{"有tenant_id?"}
HasJWT --> |是| ResolveFromJWT["从JWT解析租户"]
HasJWT --> |否| ResolveFromRequest["从请求解析租户标识"]
ResolveFromRequest --> HasIdentifier{"有标识?"}
HasIdentifier --> |否| ThrowException["抛出TenantException"]
HasIdentifier --> |是| ResolveTenant["解析租户"]
ResolveTenant --> TenantExists{"租户存在?"}
TenantExists --> |否| ThrowException
TenantExists --> |是| IsActive{"租户激活?"}
IsActive --> |否| ThrowException
IsActive --> |是| SetContext["设置租户上下文"]
SetContext --> CallNext
CallNext --> Cleanup["清理租户上下文"]
Cleanup --> End([响应返回])
ThrowException --> End
```

**图示来源**
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L133)

### 各层租户使用
- **领域层**：实体继承`AuditableEntity`，自动包含`TenantId`字段
- **应用层**：命令处理器通过`ITenantContextAccessor`获取当前租户ID
- **基础设施层**：EF Core配置中为所有实体添加`(TenantId)`索引，确保数据隔离
- **前端层**：`request.ts`拦截器自动将`X-Tenant-Id`头添加到所有请求

**本节来源**
- [TenantMiddleware.cs](file://Backend/Hrevolve.Web/Middleware/TenantMiddleware.cs#L6-L133)
- [ITenantContext.cs](file://Backend/Hrevolve.Shared/MultiTenancy/ITenantContext.cs#L6-L81)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs#L11-L12)
- [request.ts](file://Frontend/hrevolve-web/src/api/request.ts#L26-L28)