# 代码规范

<cite>
**本文档引用的文件**  
- [Employee.cs](file://Backend/Hrevolve.Domain/Employees/Employee.cs)
- [JobHistory.cs](file://Backend/Hrevolve.Domain/Employees/JobHistory.cs)
- [AuditableEntity.cs](file://Backend/Hrevolve.Domain/Common/AuditableEntity.cs)
- [Entity.cs](file://Backend/Hrevolve.Domain/Common/Entity.cs)
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs)
- [LoginCommand.cs](file://Backend/Hrevolve.Application/Identity/Commands/LoginCommand.cs)
- [LoggingBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/LoggingBehavior.cs)
- [ValidationBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/ValidationBehavior.cs)
- [EmployeesController.cs](file://Backend/Hrevolve.Web/Controllers/EmployeesController.cs)
- [employee.ts](file://Frontend/hrevolve-web/src/api/modules/employee.ts)
- [request.ts](file://Frontend/hrevolve-web/src/api/request.ts)
- [index.ts](file://Frontend/hrevolve-web/src/api/index.ts)
- [types/index.ts](file://Frontend/hrevolve-web/src/types/index.ts)
</cite>

## 目录
1. [C# 领域实体规范](#c-领域实体规范)
2. [TypeScript 类型定义规范](#typescript-类型定义规范)
3. [MediatR 命令/查询规范](#mediatr-命令查询规范)
4. [前端 API 模块化封装](#前端-api-模块化封装)
5. [提交信息规范](#提交信息规范)
6. [Pull Request 审查要点](#pull-request-审查要点)

## C# 领域实体规范

### 命名约定（PascalCase）
所有 C# 领域实体类、属性、方法均采用 PascalCase 命名法。类名应为单数名词，清晰表达业务概念。例如：
- `Employee`（员工）
- `JobHistory`（职位历史）
- `LeaveRequest`（请假申请）
- `PayrollRecord`（薪资记录）

该命名约定在项目中一致应用，如 `Employee.cs` 和 `JobHistory.cs` 文件所示。

### 属性设计原则
#### 私有构造函数
所有领域实体均采用私有无参构造函数，防止通过反射或 ORM 外部直接实例化，确保对象状态一致性。

```csharp
private Employee() { }
private JobHistory() { }
```

#### 工厂方法
通过静态工厂方法 `Create` 创建实体实例，集中处理默认值设置、业务规则验证和领域事件发布。

```csharp
public static Employee Create(
    Guid tenantId,
    string employeeNumber,
    string firstName,
    string lastName,
    Gender gender,
    DateOnly dateOfBirth,
    DateOnly hireDate,
    EmploymentType employmentType)
{
    var employee = new Employee
    {
        TenantId = tenantId,
        EmployeeNumber = employeeNumber,
        FirstName = firstName,
        LastName = lastName,
        Gender = gender,
        DateOfBirth = dateOfBirth,
        HireDate = hireDate,
        EmploymentType = employmentType,
        Status = EmploymentStatus.Active
    };
    
    employee.AddDomainEvent(new EmployeeCreatedEvent(employee.Id, tenantId));
    return employee;
}
```

实体属性采用私有 `set` 访问器，确保状态只能通过定义明确的业务方法修改。

**本节来源**  
- [Employee.cs](file://Backend/Hrevolve.Domain/Employees/Employee.cs#L49-L76)
- [JobHistory.cs](file://Backend/Hrevolve.Domain/Employees/JobHistory.cs#L57-L80)

### SCD Type 2 历史追溯实现模式
通过 `JobHistory` 实体实现 SCD（缓慢变化维度）Type 2 模式，支持员工职位、薪资等信息的历史状态追溯。

关键设计要素：
- **有效起止日期**：`EffectiveStartDate` 和 `EffectiveEndDate` 定义记录的有效时间范围。
- **当前记录标识**：`EffectiveEndDate` 默认为 `9999-12-31`，表示当前有效记录。
- **历史查询**：通过 `GetEmployeeAtDateQuery` 查询指定日期的员工状态。
- **数据修正**：支持 `CorrectionStatus` 和 `CorrectionRefId` 字段处理历史数据修正。

```csharp
public class JobHistory : AuditableEntity
{
    public DateOnly EffectiveStartDate { get; private set; }
    public DateOnly EffectiveEndDate { get; private set; } = new(9999, 12, 31);
    public CorrectionStatus? CorrectionStatus { get; private set; }
    public Guid? CorrectionRefId { get; private set; }
}
```

此模式确保了数据的完整性和可审计性，支持 HR 系统的合规性要求。

**本节来源**  
- [JobHistory.cs](file://Backend/Hrevolve.Domain/Employees/JobHistory.cs#L17-L56)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs#L96-L145)

## TypeScript 类型定义规范

### 接口命名（I前缀）
所有 TypeScript 接口均采用 `I` 前缀命名，以明确区分于类型别名和类。例如：
- `IUser`
- `IEmployee`
- `IJobHistory`
- `IAttendanceRecord`

该约定在 `types/index.ts` 文件中统一定义，确保前端类型系统的一致性。

### 模块化组织方式
类型定义采用模块化组织，按业务领域划分在 `types/index.ts` 文件中，并通过 `export` 关键字统一导出。

```typescript
// ==================== 用户与认证 ====================
export interface IUser { /* ... */ }

// ==================== 员工管理 ====================
export interface IEmployee { /* ... */ }
export interface IJobHistory { /* ... */ }

// ==================== 组织架构 ====================
export interface IOrganizationUnit { /* ... */ }
export interface IPosition { /* ... */ }
```

这种组织方式提高了代码的可维护性和可发现性，开发者可以快速定位所需类型。

**本节来源**  
- [types/index.ts](file://Frontend/hrevolve-web/src/types/index.ts#L31-L771)

## MediatR 命令/查询规范

### 结构标准
MediatR 命令和查询遵循 CQRS 模式，采用 `record` 类型定义不可变请求，并实现 `IRequest<T>` 接口。

#### 命令（Commands）
- 位于 `Application/[Feature]/Commands/` 目录
- 命名格式：`[Action][Entity]Command`
- 返回 `Result<T>` 类型

```csharp
public record CreateEmployeeCommand : IRequest<Result<Guid>>
{
    public string EmployeeNumber { get; init; } = null!;
    public string FirstName { get; init; } = null!;
    // ... 其他属性
}
```

#### 查询（Queries）
- 位于 `Application/[Feature]/Queries/` 目录
- 命名格式：`Get[Entity][Detail]Query`
- 返回 `Result<T>` 类型

```csharp
public record GetEmployeeQuery(Guid EmployeeId) : IRequest<Result<EmployeeDto>>;
```

### 处理器与行为
每个命令/查询都有对应的处理器类，实现 `IRequestHandler<T>` 接口。

```csharp
public class CreateEmployeeCommandHandler(
    IEmployeeRepository employeeRepository,
    IUnitOfWork unitOfWork,
    ITenantContextAccessor tenantContextAccessor) : IRequestHandler<CreateEmployeeCommand, Result<Guid>>
{
    public async Task<Result<Guid>> Handle(CreateEmployeeCommand request, CancellationToken cancellationToken)
    {
        // 处理逻辑
    }
}
```

管道行为（Behaviors）用于横切关注点：
- `ValidationBehavior`：自动执行 FluentValidation 验证
- `LoggingBehavior`：记录请求处理日志

**本节来源**  
- [CreateEmployeeCommand.cs](file://Backend/Hrevolve.Application/Employees/Commands/CreateEmployeeCommand.cs#L6-L126)
- [GetEmployeeQuery.cs](file://Backend/Hrevolve.Application/Employees/Queries/GetEmployeeQuery.cs#L41-L146)
- [LoggingBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/LoggingBehavior.cs#L6-L51)
- [ValidationBehavior.cs](file://Backend/Hrevolve.Application/Behaviors/ValidationBehavior.cs#L8-L43)

## 前端 API 模块化封装

### axios 实例封装
通过 `request.ts` 文件封装 axios 实例，统一配置基础 URL、超时时间和请求头。

```typescript
const service: AxiosInstance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
});
```

### 请求拦截器
在请求拦截器中自动添加认证 Token 和租户 ID。

```typescript
service.interceptors.request.use(
  (config) => {
    const authStore = useAuthStore();
    
    if (authStore.token) {
      config.headers.Authorization = `Bearer ${authStore.token}`;
    }
    
    if (authStore.tenantId && authStore.tenantId.trim()) {
      config.headers['X-Tenant-Id'] = authStore.tenantId;
    }
    
    return config;
  }
);
```

### 响应拦截器
统一处理响应和错误，实现自动跳转登录页、显示错误消息等。

```typescript
service.interceptors.response.use(
  (response: AxiosResponse) => {
    return {
      ...response,
      data: {
        success: true,
        data: response.data,
        message: 'success'
      }
    };
  },
  (error) => {
    const { response } = error;
    
    if (response?.status === 401) {
      ElMessage.error('登录已过期，请重新登录');
      const authStore = useAuthStore();
      authStore.logout();
      window.location.href = '/login';
    }
    // ... 其他错误处理
  }
);
```

### 模块化 API 定义
按业务模块组织 API，每个模块导出一个包含相关方法的对象。

```typescript
export const employeeApi = {
  getList(params: PageRequest & { departmentId?: string; status?: string; keyword?: string }) {
    return request.get<PageResponse<Employee>>('/employees', { params });
  },
  
  getById(id: string) {
    return request.get<Employee>(`/employees/${id}`);
  },
  
  getAtDate(id: string, date: string) {
    return request.get<Employee>(`/employees/${id}/at-date`, { params: { date } });
  },
  // ... 其他方法
};
```

所有模块在 `api/index.ts` 中统一导出，便于全局导入。

**本节来源**  
- [request.ts](file://Frontend/hrevolve-web/src/api/request.ts#L6-L107)
- [employee.ts](file://Frontend/hrevolve-web/src/api/modules/employee.ts#L5-L51)
- [index.ts](file://Frontend/hrevolve-web/src/api/index.ts#L1-L19)

## 提交信息规范

所有代码提交必须遵循 Conventional Commits 规范，格式为：

```
<type>(<scope>): <description>

[optional body]

[optional footer(s)]
```

### 类型（type）
- `feat`：新增功能
- `fix`：修复缺陷
- `docs`：文档更新
- `style`：代码格式调整（不影响逻辑）
- `refactor`：代码重构
- `perf`：性能优化
- `test`：测试相关
- `chore`：构建过程或辅助工具变动

### 范围（scope）
可选，指明提交影响的模块，如 `employee`、`leave`、`payroll`、`auth` 等。

### 示例
```
feat(employee): 实现员工入职SCD Type 2历史追溯

- 添加JobHistory实体支持职位变更历史
- 实现GetEmployeeAtDate查询
- 更新Employee聚合根方法

Closes #123
```

```
fix(auth): 修复JWT令牌生成时权限声明缺失问题

- 确保生成令牌时包含用户权限声明
- 修复权限验证逻辑

Fixes #456
```

## Pull Request 审查要点

### 领域逻辑放置位置
- **领域实体**：核心业务规则和不变性应在领域实体中实现（如 `Employee` 类的方法）。
- **应用服务**：业务流程编排应在应用层的 MediatR 处理器中实现。
- **基础设施**：数据访问、外部服务调用应在基础设施层实现。

### 依赖注入注册正确性
- 确保所有服务在 `DependencyInjection.cs` 文件中正确注册。
- 使用适当的生命周期（`Scoped`、`Singleton`、`Transient`）。
- 避免循环依赖。

### 其他审查要点
- **SCD Type 2 实现**：历史数据变更是否正确创建新记录而非更新旧记录。
- **工厂方法**：实体创建是否通过工厂方法而非公共构造函数。
- **私有构造函数**：领域实体是否具有私有构造函数。
- **MediatR 管道行为**：是否正确应用 `ValidationBehavior` 和 `LoggingBehavior`。
- **前端类型安全**：API 调用是否使用正确的 TypeScript 类型。
- **错误处理**：是否妥善处理异常情况并返回有意义的错误信息。
- **安全性**：敏感操作是否进行权限验证（`[RequirePermission]` 特性）。
- **多租户隔离**：数据访问是否正确应用租户上下文。