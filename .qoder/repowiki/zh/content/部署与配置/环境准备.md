# 环境准备

<cite>
**本文档引用文件**  
- [appsettings.json](file://Backend/Hrevolve.Web/appsettings.json)
- [appsettings.Development.json](file://Backend/Hrevolve.Web/appsettings.Development.json)
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs)
- [Hrevolve.Web.csproj](file://Backend/Hrevolve.Web/Hrevolve.Web.csproj)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs)
- [vite.config.ts](file://Frontend/hrevolve-web/vite.config.ts)
- [.env.development](file://Frontend/hrevolve-web/.env.development)
- [.env.production](file://Frontend/hrevolve-web/.env.production)
- [package.json](file://Frontend/hrevolve-web/package.json)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [后端环境准备](#后端环境准备)
3. [前端环境准备](#前端环境准备)
4. [配置文件详解](#配置文件详解)
5. [跨平台安装指南](#跨平台安装指南)
6. [常见问题排查](#常见问题排查)

## 简介
Hrevolve 是一个基于 .NET 10 和 Vue 3 的企业级 SaaS 人力资源管理系统，采用 Clean Architecture 和领域驱动设计（DDD）。本指南详细说明开发和生产环境所需的软件依赖与配置，包括 .NET 10 SDK、Node.js 18+、PostgreSQL 16、Redis 7 的安装与版本要求，以及关键配置项的设置方式。

## 后端环境准备

### 软件依赖
根据项目结构和 `Hrevolve.Web.csproj` 文件，后端环境需要以下软件：

- **.NET 10 SDK**：项目目标框架为 `net10.0`，必须安装 .NET 10 SDK
- **PostgreSQL 16+**：作为主数据库，用于存储所有业务数据
- **Redis 7+**：用于分布式缓存和会话存储
- **Entity Framework Core 10**：用于数据库迁移和数据访问

### 安装步骤
#### Windows
```powershell
# 安装 .NET 10 SDK (需从官方预览通道获取)
winget install Microsoft.dotnet.10

# 安装 PostgreSQL 16
winget install PostgreSQL.PostgreSQL --version 16

# 安装 Redis 7
winget install RedisLabs.Redis
```

#### Linux (Ubuntu/Debian)
```bash
# 添加 .NET 10 预览版仓库并安装
wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install -y apt-transport-https
sudo apt-get update
sudo apt-get install -y dotnet-sdk-10.0

# 安装 PostgreSQL 16
sudo apt-get install -y postgresql-16 postgresql-contrib-16

# 安装 Redis 7
sudo apt-get install -y redis-server
```

#### macOS
```bash
# 使用 Homebrew 安装
brew tap homebrew/cask-versions
brew install --cask dotnet-preview
brew install postgresql@16 redis
```

### 验证步骤
```bash
# 验证 .NET SDK 版本
dotnet --version
# 应输出以 10 开头的版本号

# 验证 PostgreSQL
psql --version
# 应输出 16.x 版本

# 验证 Redis
redis-server --version
# 应输出 7.x 版本
```

**Section sources**
- [Hrevolve.Web.csproj](file://Backend/Hrevolve.Web/Hrevolve.Web.csproj#L4)
- [README.md](file://README.md#L108-L111)

## 前端环境准备

### 软件依赖
根据 `package.json` 文件，前端环境需要：

- **Node.js 18+**：项目依赖的 TypeScript 版本需要 Node.js 18+ 支持
- **npm 或 yarn**：包管理工具
- **Vite**：构建工具

### 安装步骤
#### Windows
```powershell
# 使用 winget 安装 Node.js 18+
winget install OpenJS.NodeJS.LTS

# 或使用 nvm-windows
nvm install 18
nvm use 18
```

#### Linux (Ubuntu/Debian)
```bash
# 使用 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### macOS
```bash
# 使用 Homebrew
brew install node@18

# 或使用 nvm
nvm install 18
nvm use 18
```

### 项目依赖安装
```bash
cd Frontend/hrevolve-web
npm install
```

### 验证步骤
```bash
# 验证 Node.js 版本
node --version
# 应输出 v18.x.x

# 验证 npm 版本
npm --version
# 应输出 9.x 或更高版本

# 验证项目可运行
npm run dev
```

**Section sources**
- [package.json](file://Frontend/hrevolve-web/package.json#L24-L28)
- [README.md](file://README.md#L109)

## 配置文件详解

### 后端配置 (appsettings.json)

#### 数据库连接
```json
"ConnectionStrings": {
  "DefaultConnection": "Host=localhost;Port=5432;Database=hrevolve;Username=postgres;Password=postgres",
  "Redis": "localhost:6379"
}
```

- **DefaultConnection**：PostgreSQL 连接字符串，格式为 `Host=主机;Port=端口;Database=数据库名;Username=用户名;Password=密码`
- **Redis**：Redis 服务器地址，格式为 `主机:端口`

#### AI 配置
```json
"AI": {
  "Provider": "Mock",
  "ApiKey": "",
  "Model": "gpt-4o",
  "Endpoint": "",
  "DeploymentName": ""
}
```

- **Provider**：AI 服务提供商，可选值：`OpenAI`、`Azure`、`Mock`
- **ApiKey**：OpenAI API 密钥或 Azure API 密钥
- **Model**：使用的模型名称，默认为 `gpt-4o`
- **Endpoint**：Azure OpenAI 服务端点
- **DeploymentName**：Azure 部署名称

#### JWT 配置
```json
"Jwt": {
  "Key": "your-256-bit-secret-key-here-must-be-at-least-32-characters",
  "Issuer": "https://hrevolve.local",
  "Audience": "https://hrevolve.local"
}
```

**Section sources**
- [appsettings.json](file://Backend/Hrevolve.Web/appsettings.json#L2-L17)
- [DependencyInjection.cs](file://Backend/Hrevolve.Agent/DependencyInjection.cs#L13-L17)
- [Design/Agent.md](file://Design/Agent.md#L220-L232)

### 前端配置

#### 环境变量 (Vite)
```env
VITE_API_BASE_URL=/api
```

- **VITE_API_BASE_URL**：API 基础路径，开发环境下为 `/api`，由 Vite 代理处理

#### 代理配置 (vite.config.ts)
```typescript
server: {
  proxy: {
    '/api': {
      target: 'https://localhost:5225',
      changeOrigin: true,
      secure: false,
    },
  },
}
```

- 开发服务器将 `/api` 请求代理到 `https://localhost:5225`
- `secure: false` 允许使用自签名证书
- `changeOrigin: true` 修改请求头中的 Origin

**Section sources**
- [.env.development](file://Frontend/hrevolve-web/.env.development#L3)
- [vite.config.ts](file://Frontend/hrevolve-web/vite.config.ts#L14-L19)

## 跨平台安装指南

### Windows 完整安装流程
```powershell
# 1. 安装 .NET 10 SDK
winget install Microsoft.dotnet.10

# 2. 安装 Node.js 18+
winget install OpenJS.NodeJS.LTS

# 3. 安装 PostgreSQL 16
winget install PostgreSQL.PostgreSQL --version 16

# 4. 安装 Redis 7
winget install RedisLabs.Redis

# 5. 启动服务
net start postgresql-x64-16
net start redis

# 6. 配置数据库
psql -U postgres -c "CREATE DATABASE hrevolve;"
psql -U postgres -c "CREATE USER postgres WITH PASSWORD 'postgres';"

# 7. 安装前端依赖
cd Frontend/hrevolve-web
npm install

# 8. 运行后端
cd ../..
cd Backend
dotnet restore
dotnet run --project Hrevolve.Web
```

### Linux 完整安装流程
```bash
# 1. 安装 .NET 10 SDK
sudo apt-get install -y dotnet-sdk-10.0

# 2. 安装 Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 3. 安装 PostgreSQL 16
sudo apt-get install -y postgresql-16

# 4. 安装 Redis 7
sudo apt-get install -y redis-server

# 5. 启动服务
sudo systemctl start postgresql
sudo systemctl start redis-server

# 6. 配置数据库
sudo -u postgres psql -c "CREATE DATABASE hrevolve;"
sudo -u postgres psql -c "CREATE USER postgres WITH PASSWORD 'postgres';"

# 7. 安装前端依赖
cd Frontend/hrevolve-web
npm install

# 8. 运行后端
cd ../../Backend
dotnet restore
dotnet run --project Hrevolve.Web
```

### macOS 完整安装流程
```bash
# 1. 安装 .NET 10 SDK
brew install --cask dotnet-preview

# 2. 安装 Node.js 18+
brew install node@18
echo 'export PATH="/opt/homebrew/opt/node@18/bin:$PATH"' >> ~/.zshrc

# 3. 安装 PostgreSQL 16
brew install postgresql@16

# 4. 安装 Redis 7
brew install redis

# 5. 启动服务
brew services start postgresql@16
brew services start redis

# 6. 配置数据库
psql -U $(whoami) -c "CREATE DATABASE hrevolve;"

# 7. 安装前端依赖
cd Frontend/hrevolve-web
npm install

# 8. 运行后端
cd ../../Backend
dotnet restore
dotnet run --project Hrevolve.Web
```

## 常见问题排查

### 数据库连接失败
**症状**：应用启动时抛出 `NpgsqlException` 或连接超时
**解决方案**：
1. 确认 PostgreSQL 服务已启动
2. 检查 `appsettings.json` 中的连接字符串
3. 验证用户名和密码是否正确
4. 检查防火墙设置，确保 5432 端口开放

### Redis 连接失败
**症状**：应用启动时抛出 `RedisConnectionException`
**解决方案**：
1. 确认 Redis 服务已启动
2. 检查 `appsettings.json` 中的 Redis 配置
3. 验证 Redis 服务器是否在指定端口监听

### 前端代理失败
**症状**：前端页面显示网络错误，API 请求返回 404
**解决方案**：
1. 确认后端服务正在运行（默认端口 5225）
2. 检查 `vite.config.ts` 中的代理配置
3. 验证 `VITE_API_BASE_URL` 环境变量设置正确

### .NET SDK 版本错误
**症状**：`dotnet restore` 报错，提示找不到 `net10.0` 框架
**解决方案**：
1. 确认已安装 .NET 10 SDK 而不是运行时
2. 运行 `dotnet --list-sdks` 查看已安装的 SDK
3. 如果使用 .NET 多版本管理，确保正确版本被选中

### Node.js 版本不兼容
**症状**：`npm install` 报错，提示 TypeScript 或 Vite 兼容性问题
**解决方案**：
1. 确认 Node.js 版本为 18.x
2. 清理 npm 缓存：`npm cache clean --force`
3. 删除 `node_modules` 和 `package-lock.json` 后重新安装

**Section sources**
- [appsettings.json](file://Backend/Hrevolve.Web/appsettings.json#L3)
- [vite.config.ts](file://Frontend/hrevolve-web/vite.config.ts#L15-L18)
- [Program.cs](file://Backend/Hrevolve.Web/Program.cs#L7-L17)
- [DependencyInjection.cs](file://Backend/Hrevolve.Infrastructure/DependencyInjection.cs#L16-L32)